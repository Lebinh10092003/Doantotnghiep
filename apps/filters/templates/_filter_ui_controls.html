{% load group_tags %}
{% load static %}
{% load filter_tags %}
{% load widget_tweaks %} 

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    
    <button type="button" class="btn btn-outline-secondary btn-sm" @click="showFilters = !showFilters">
      <i class="bi bi-funnel-fill"></i>
      <span x-text="showFilters ? 'Ẩn Filter' : 'Hiện Filter'">Filter</span>
    </button>

    <div class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm"
              hx-get="{% url 'filters:load_saved_filters' model_name %}?target_id={{ target_id|default:'filterable-content' }}&current_query_params={{ request.GET.urlencode }}&origin_path={{ request.path }}"
              hx-target="#filter-modal-content"
              hx-trigger="click, reload-saved-filters-{{ model_name }} from:body"
              @click="modalTitle = 'Chọn bộ lọc đã lưu'">
        <i class="bi bi-star-fill"></i> Bộ lọc đã lưu
      </button>
      
    </div> 
  </div>
{% if active_filter_name %}
  <div class="d-flex align-items-center gap-2 mb-3">
    <span class="text-muted small">Đang lọc theo:</span>
    <span class="badge bg-primary d-flex align-items-center gap-2">
      {{ active_filter_name }}
      <a href="{{ request.path }}" 
         class="text-white" 
         hx-get="{{ request.path }}"
         hx-target="#{{ target_id|default:'filterable-content' }}" hx-swap="innerHTML"
         hx-push-url="true"
         title="Xóa bộ lọc này"><i class="bi bi-x-circle"></i></a>
    </span>
  </div>
{% endif %}
{% if active_filter_badges and not active_filter_name %}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span class="text-muted small">Đang lọc theo:</span>
    {% for badge in active_filter_badges %}
    <span class="badge bg-light text-dark border d-flex align-items-center gap-2">
      <span><strong>{{ badge.label }}:</strong> {{ badge.value }}</span>
      <a href="{{ request.path }}?{% remove_query_param badge.key %}"
         class="text-danger"
         title="Xóa bộ lọc '{{ badge.label }}'"
         hx-get="{{ request.path }}?{% remove_query_param badge.key %}"
         hx-target="#{{ target_id|default:'filterable-content' }}"
         hx-swap="innerHTML"
         hx-push-url="true"
         ><i class="bi bi-x-circle"></i></a>
    </span>
    {% endfor %}
    <a href="{{ request.path }}" 
       class="btn btn-sm btn-outline-danger" 
       hx-get="{{ request.path }}"
       hx-target="#{{ target_id|default:'filterable-content' }}" hx-swap="innerHTML"
       hx-push-url="true"
       title="Xóa tất cả bộ lọc">
       <i class="bi bi-x-lg"></i> Xóa tất cả
    </a>
  </div>
{% endif %}

<div x-show="showFilters" x-transition class="card card-body bg-light border mb-3" style="display: none;">
  <h6 class="mb-3">Tùy chọn lọc</h6>
  <form id="filter-form" method="get" action="" class="row g-3"
        hx-get="{{ request.path }}"
        hx-target="#{{ target_id|default:'filterable-content' }}"
        hx-swap="innerHTML"
        hx-push-url="true">
    {% for field in filter.form %}
      <div class="col-md-4 col-sm-6">
        <label for="{{ field.id_for_label }}" class="form-label small">{{ field.label }}</label>
        {% with widget_type=field.field.widget_type existing_classes=field.field.widget.attrs.class %}
          {% if widget_type == 'rangewidget' %}
            <div class="input-group">
              {% with start_placeholder=field.field.widget.widgets.0.attrs.placeholder end_placeholder=field.field.widget.widgets.1.attrs.placeholder %}
                {% if start_placeholder %}
                  {% render_field field.field.widget.widgets.0 class+="form-control" placeholder=start_placeholder %}
                {% else %}
                  {% render_field field.field.widget.widgets.0 class+="form-control" placeholder="Từ ngày" %}
                {% endif %}
                {% if end_placeholder %}
                  {% render_field field.field.widget.widgets.1 class+="form-control" placeholder=end_placeholder %}
                {% else %}
                  {% render_field field.field.widget.widgets.1 class+="form-control" placeholder="Đến ngày" %}
                {% endif %}
              {% endwith %}
            </div>
          {% elif widget_type == 'select' or widget_type == 'selectmultiple' %}
            {% if existing_classes %}
              {% render_field field %}
            {% else %}
              {% render_field field class+="form-select" %}
            {% endif %}
          {% else %}
            {% if existing_classes %}
              {% render_field field %}
            {% else %}
              {% render_field field class+="form-control" %}
            {% endif %}
          {% endif %}
        {% endwith %}
      </div>
    {% endfor %}
    <div class="col-12 d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-outline-primary"
              hx-get="{% url 'filters:save_filter' %}?model_name={{ model_name }}&{{ current_query_params }}"
              hx-target="#filter-modal-content"
              hx-swap="innerHTML"
              @click="modalTitle = 'Lưu bộ lọc hiện tại'">
        <i class="bi bi-save"></i> Lưu bộ lọc
      </button>

      <a href="{{ request.path }}" class="btn btn-light-secondary">Xóa lọc</a>
      <button type="submit" class="btn btn-primary">Áp dụng</button>
    </div>
  </form>
</div>
