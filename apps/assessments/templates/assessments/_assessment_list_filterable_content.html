{% load humanize %}

<div x-data="{showFilters:false, modalTitle:'Bộ lọc'}">
  {% include "_filter_ui_controls.html" with filter=filter active_filter_name=active_filter_name model_name=model_name current_query_params=current_query_params active_filter_badges=active_filter_badges target_id='filterable-content' %}

  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="p-3 border rounded bg-light h-100">
        <div class="text-muted text-uppercase small">Tổng lượt đánh giá</div>
        <div class="fs-4 fw-semibold mb-0">{{ stats.total|default:0|intcomma }}</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="p-3 border rounded bg-light h-100">
        <div class="text-muted text-uppercase small">Đã chấm điểm</div>
        <div class="fs-4 fw-semibold mb-0 text-success">{{ stats.scored|default:0|intcomma }}</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="p-3 border rounded bg-light h-100">
        <div class="text-muted text-uppercase small">Chưa chấm</div>
        <div class="fs-4 fw-semibold mb-0 text-warning">{{ stats.pending|default:0|intcomma }}</div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
      <div class="p-3 border rounded bg-light h-100">
        <div class="text-muted text-uppercase small">Điểm trung bình</div>
        <div class="fs-4 fw-semibold mb-0">{% if stats.avg_score %}{{ stats.avg_score|floatformat:1 }}{% else %}—{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mb-3">
        <div class="dataTable-dropdown d-flex align-items-center gap-2 ms-auto">
          <select name="per_page"
                  class="dataTable-selector form-select form-select-sm w-auto"
                  hx-get="{{ request.path }}"
                  hx-target="#filterable-content"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  hx-include="#filter-form"
                  hx-trigger="change"
                  hx-vals='{"page":"1"}'>
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
          <label class="mb-0 small text-muted">mục/trang</label>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Ngày</th>
              <th>Buổi học</th>
              <th>Lớp</th>
              <th>Trung tâm</th>
              <th>Học sinh</th>
              <th class="text-center">Điểm</th>
              <th>Nhận xét</th>
            </tr>
          </thead>
          <tbody>
            {% if page_obj and page_obj.object_list %}
              {% for assessment in page_obj %}
              <tr>
                <td>{{ assessment.session.date|date:"d/m/Y"|default:"—" }}</td>
                <td>
                  <div class="fw-semibold">Buổi {{ assessment.session.index }}</div>
                  <small class="text-muted">{{ assessment.session.lesson.title|default:"Chưa cập nhật bài học" }}</small>
                </td>
                <td>
                  <div class="fw-semibold">{{ assessment.session.klass.name }}</div>
                  <small class="text-muted">{{ assessment.session.klass.code }}</small>
                </td>
                <td>{{ assessment.session.klass.center.name }}</td>
                <td>
                  <div class="fw-semibold">{{ assessment.student.display_name_with_email }}</div>
                  <small class="text-muted">{{ assessment.student.user_code|default:assessment.student.preferred_email|default:"Chưa có thông tin" }}</small>
                </td>
                <td class="text-center">
                  {% if assessment.score is not None %}
                    <span class="badge bg-success-subtle text-success fw-semibold">{{ assessment.score|floatformat:1 }}</span>
                  {% else %}
                    <span class="badge bg-warning-subtle text-warning">Chưa chấm</span>
                  {% endif %}
                </td>
                <td>{{ assessment.remark|default:"—" }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">Không tìm thấy dữ liệu phù hợp.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-footer border-0 bg-light">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="text-muted small mb-0">
          {% if paginator.count %}
            Hiện {{ page_obj.start_index }} đến {{ page_obj.end_index }} trên tổng {{ paginator.count }} lượt đánh giá
          {% else %}
            Không có lượt đánh giá phù hợp
          {% endif %}
        </div>
        {% if page_obj and page_obj.has_other_pages %}
        <nav aria-label="Phân trang đánh giá" class="dataTable-pagination">
          <ul class="pagination justify-content-end mb-0">
            {% if page_obj.number > 1 %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ request.path }}?page=1{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-get="{{ request.path }}?page=1{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-target="#filterable-content"
                 hx-swap="innerHTML"
                 hx-push-url="true">Đầu</a>
            </li>
            {% endif %}
            {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ request.path }}?page={{ page_obj.previous_page_number }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-get="{{ request.path }}?page={{ page_obj.previous_page_number }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-target="#filterable-content"
                 hx-swap="innerHTML"
                 hx-push-url="true">Trước</a>
            </li>
            {% endif %}
            {% for p in paginator.page_range %}
              {% if p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
              <li class="page-item {% if page_obj.number == p %}active{% endif %}">
                <a class="page-link"
                   href="{{ request.path }}?page={{ p }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                   hx-get="{{ request.path }}?page={{ p }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                   hx-target="#filterable-content"
                   hx-swap="innerHTML"
                   hx-push-url="true">{{ p }}</a>
              </li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ request.path }}?page={{ page_obj.next_page_number }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-get="{{ request.path }}?page={{ page_obj.next_page_number }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-target="#filterable-content"
                 hx-swap="innerHTML"
                 hx-push-url="true">Sau</a>
            </li>
            {% endif %}
            {% if page_obj.number < paginator.num_pages %}
            <li class="page-item">
              <a class="page-link"
                 href="{{ request.path }}?page={{ paginator.num_pages }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-get="{{ request.path }}?page={{ paginator.num_pages }}{% if pagination_query_params %}&{{ pagination_query_params }}{% endif %}"
                 hx-target="#filterable-content"
                 hx-swap="innerHTML"
                 hx-push-url="true">Cuối</a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="modal fade" id="filter-modal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel" x-text="modalTitle">Bộ lọc</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="filter-modal-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail && evt.detail.target && evt.detail.target.id === 'filter-modal-content') {
      const modalEl = document.getElementById('filter-modal');
      if (modalEl) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    }
  });
</script>
