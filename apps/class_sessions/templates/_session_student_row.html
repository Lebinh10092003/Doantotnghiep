{% load widget_tweaks %}

<tr 
  id="student-row-{{ data.student.id }}"
  class="student-row {% if success %}flash-success{% endif %}"
>
  <td class="fw-bold">
    {{ data.student.get_full_name|default:data.student.username }}
  </td>
  
  {# Cột trạng thái điểm danh #}
  <td>
    {% if data.attendance %}
      {% if data.attendance.status == "P" %}
        <span class="badge bg-success">Có mặt</span>
      {% elif data.attendance.status == "A" %}
        <span class="badge bg-danger">Vắng</span>
      {% elif data.attendance.status == "L" %}
        <span class="badge bg-warning text-dark">Muộn</span>
      {% else %}
        <span class="badge bg-secondary">{{ data.attendance.get_status_display }}</span>
      {% endif %}
    {% else %}
      <span class="badge bg-secondary">Chưa điểm danh</span>
    {% endif %}
  </td>
  
  {# Cột Ghi chú điểm danh #}
  <td>
    {% if data.attendance and data.attendance.note %}
      <span class="text-body">{{ data.attendance.note }}</span>
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  
  {# Cột Điểm #}
  <td>
    {% if data.assessment and data.assessment.score is not None %}
      {{ data.assessment.score }}
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  
  {# Cột Nhận xét #}
  <td>
    {% if data.assessment and data.assessment.remark %}
      <span class="text-body">{{ data.assessment.remark }}</span>
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  
  {# Cột Hành động #}
  <td class="text-nowrap">
    <div class="d-flex gap-1">
      {# Mở modal Điểm danh & Đánh giá riêng (attendance-modal riêng) #}
      {% if perms.attendance.change_attendance or perms.assessments.change_assessment %}
      <button type="button" 
              class="btn btn-sm btn-primary"
              hx-get="{% url 'class_sessions:student_attendance_assessment_modal' session.id data.student.id %}?_={{ data.student.id }}-{% now 'U' %}"
              hx-target="#attendance-modal-content"
              hx-on::after-request="if(event.detail.successful) bootstrap.Modal.getOrCreateInstance(document.getElementById('attendance-modal')).show()"
              title="Điểm danh &amp; đánh giá cho học sinh này">
        <i class="bi bi-clipboard-check"></i>
      </button>
      {% endif %}

      {# Nút xem chi tiết HS - dùng sessions-modal chung #}
      {% if perms.accounts.view_user %}
      <button type="button" 
              class="btn btn-sm btn-info"
              hx-get="{% url 'accounts:user_detail' data.student.id %}"
              hx-target="#sessions-modal-content"
              data-bs-toggle="modal" 
              data-bs-target="#sessions-modal"
              @click="modalTitle = 'Chi tiết Học sinh: {{ data.student.get_full_name|default:data.student.username|escapejs }}'"
              title="Xem chi tiết học sinh">
        <i class="bi bi-person"></i>
      </button>
      {% endif %}

      {# Nút xem Phụ huynh (nếu có) - dùng sessions-modal chung #}
      {% if perms.accounts.view_user and data.parents %}
        {% with parent=data.parents.0 %}
        <button type="button" 
                class="btn btn-sm btn-warning"
                hx-get="{% url 'accounts:user_detail' parent.id %}"
                hx-target="#sessions-modal-content"
                data-bs-toggle="modal" 
                data-bs-target="#sessions-modal"
                @click="modalTitle = 'Chi tiết Phụ huynh: {{ parent.get_full_name|default:parent.username|escapejs }}'"
                title="Xem chi tiết phụ huynh ({{ parent.get_full_name|default:parent.username }})">
          <i class="bi bi-person-check"></i>
        </button>
        {% endwith %}
      {% endif %}
    </div>
  </td>
</tr>
