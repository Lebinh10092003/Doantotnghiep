{% load widget_tweaks %}

<tr 
  class="student-row {% if success %}flash-success{% endif %}"
  hx-target="this"
  hx-swap="outerHTML"
>
  <td class="fw-bold">
    {{ data.student.get_full_name|default:data.student.username }}
  </td>
  
  {# Cột Trạng thái Điểm danh #}
  <td>
    <select name="status" class="form-select form-select-sm" {% if not perms.attendance.change_attendance %}disabled{% endif %}>
      <option value="P" {% if not data.attendance or data.attendance.status == 'P' %}selected{% endif %}>Có mặt</option>
      <option value="A" {% if data.attendance.status == 'A' %}selected{% endif %}>Vắng</option>
      <option value="L" {% if data.attendance.status == 'L' %}selected{% endif %}>Muộn</option>
    </select>
  </td>
  
  {# Cột Ghi chú Điểm danh #}
  <td>
    <input type="text" name="note" value="{{ data.attendance.note|default:'' }}" class="form-control form-control-sm" placeholder="Ghi chú điểm danh..." {% if not perms.attendance.change_attendance %}disabled{% endif %}>
  </td>
  
  {# Cột Điểm #}
  <td>
    <input type="number" name="score" value="{{ data.assessment.score|default:'' }}" class="form-control form-control-sm" placeholder="Điểm" step="0.1" min="0" max="10" style="max-width: 80px;" {% if not perms.assessments.change_assessment %}disabled{% endif %}>
  </td>
  
  {# Cột Nhận xét #}
  <td>
    <input type="text" name="remark" value="{{ data.assessment.remark|default:'' }}" class="form-control form-control-sm" placeholder="Nhận xét..." {% if not perms.assessments.change_assessment %}disabled{% endif %}>
  </td>
  
  {# CỘT HÀNH ĐỘNG #}
  <td class="text-nowrap">
    <div class="d-flex gap-1">
      {# Nút Lưu #}
      {% if perms.attendance.change_attendance or perms.assessments.change_assessment %}
      <button type="button" 
              class="btn btn-sm btn-primary"
              hx-post="{% url 'class_sessions:update_student_session_status' session.id data.student.id %}"
              hx-include="closest tr"
              hx-indicator="closest tr"
              title="Lưu thay đổi cho học sinh này">
        <i class="bi bi-save"></i>
      </button>
      {% endif %}

      {# Nút xem chi tiết HS #}
      {% if perms.accounts.view_user %}
      <button type="button" 
              class="btn btn-sm btn-info"
              hx-get="{% url 'accounts:user_detail' data.student.id %}"
              hx-target="#sessions-modal-content"
              data-bs-toggle="modal" 
              data-bs-target="#sessions-modal"
              @click="modalTitle = 'Chi tiết Học sinh: {{ data.student.get_full_name|default:data.student.username|escapejs }}'"
              title="Xem chi tiết học sinh">
        <i class="bi bi-person"></i>
      </button>
      {% endif %}

      {# Nút xem Phụ huynh (chỉ hiển thị nếu có phụ huynh) #}
      {% if perms.accounts.view_user and data.parents %}
        {% with parent=data.parents.0 %} {# Lấy phụ huynh đầu tiên làm đại diện #}
        <button type="button" 
                class="btn btn-sm btn-warning"
                hx-get="{% url 'accounts:user_detail' parent.id %}"
                hx-target="#sessions-modal-content"
                data-bs-toggle="modal" 
                data-bs-target="#sessions-modal"
                @click="modalTitle = 'Chi tiết Phụ huynh: {{ parent.get_full_name|default:parent.username|escapejs }}'"
                title="Xem chi tiết phụ huynh ({{ parent.get_full_name|default:parent.username }})">
          <i class="bi bi-person-check"></i>
        </button>
        {% endwith %}
      {% endif %}
    </div>
  </td>
</tr>