<div class="dataTable-container table-responsive" style="width:100%; overflow-x:auto;">
  <table class="table table-striped dataTable-table" id="table1" style="width:100%;">
    <thead>
      <tr>
        <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
        <th>Họ tên</th>
        <th>Email</th>
        <th>Số điện thoại</th>
        <th>Vị trí</th>
        <th>Nhóm</th>
        <th>Cơ sở</th>
        <th>Trạng thái</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      {# group_by role: theo trường User.role #}
      {% if group_by == "role" %}
      {% regroup page_obj.object_list by role as role_list %}
      {% for role_group in role_list %}
      <tr class="table-group">
        <td colspan="9"><strong>{{ role_group.grouper|default:"(No role)" }}</strong></td>
      </tr>
      {% for user in role_group.list %}
      <tr>
        <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
        <td>{{ user.get_full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.phone }}</td>
        <td>
          {% with g=user.groups.first %}
          {% if g %}
          {{ g.name }}
          {% else %}
          {{ user.get_role_display }}
          {% endif %}
          {% endwith %}
        </td>
        <td>
          {% with first_group=user.groups.first %}
          {% if first_group %}
          {% for g in user.groups.all %}
          {% if g.name == "Admin" %}
          <span class="badge bg-success">{{ g.name }}</span>
          {% elif g.name == "Teacher" %}
          <span class="badge bg-primary">{{ g.name }}</span>
          {% elif g.name == "Student" %}
          <span class="badge bg-warning text-dark">{{ g.name }}</span>
          {% elif g.name == "Parent" %}
          <span class="badge bg-orange" style="background-color: orange;">{{ g.name }}</span>
          {% else %}
          <span class="badge bg-secondary">{{ g.name }}</span>
          {% endif %}
          {% endfor %}
          {% else %}
          &mdash;
          {% endif %}
          {% endwith %}
        </td>


        <td>
          {% if user.center %}
          {{ user.center.name }}
          {% else %}
          &mdash;
          {% endif %}
        </td>

        <td>
          {% if user.is_active %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-info"
                    hx-get="{% url 'accounts:user_detail' user.id %}"
                    hx-target="#modal-content"
                    @click="modalTitle = 'Chi tiết người dùng: {{ user.username|escapejs }}'"
                    data-bs-toggle="modal"
                    data-bs-target="#user-modal">
                <i class="bi bi-eye"></i>
            </button>
            
            <form hx-post="{% url 'accounts:delete_users' %}" hx-swap="none" class="d-inline"
                  data-confirm-title="Xác nhận xóa"
                  data-confirm-text="Bạn có chắc chắn muốn xóa người dùng '{{ user.username }}'?">
                {% csrf_token %}
                <input type="hidden" name="user_ids" value="{{ user.id }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </td>
      </tr>
      {% endfor %}
      {% endfor %}

      {% elif group_by == "group" %}
      {% regroup page_obj.object_list by groups.0.name as group_list %}
      {% for ggroup in group_list %}
      <tr class="table-group">
        <td colspan="9"><strong>{{ ggroup.grouper|default:"(No group)" }}</strong></td>
      </tr>
      {% for user in ggroup.list %}
      <tr>
        <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
        <td>{{ user.get_full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.phone }}</td>
        <td>
          {% with g=user.groups.first %}
          {% if g %}
          {{ g.name }}
          {% else %}
          {{ user.get_role_display }}
          {% endif %}
          {% endwith %}
        </td>

        <td>
          {% with first_group=user.groups.first %}
          {% if first_group %}
          {% for g in user.groups.all %}
          {% if g.name == "Admin" %}
          <span class="badge bg-success">{{ g.name }}</span>
          {% elif g.name == "Teacher" %}
          <span class="badge bg-primary">{{ g.name }}</span>
          {% elif g.name == "Student" %}
          <span class="badge bg-warning text-dark">{{ g.name }}</span>
          {% elif g.name == "Parent" %}
          <span class="badge bg-orange" style="background-color: orange;">{{ g.name }}</span>
          {% else %}
          <span class="badge bg-secondary">{{ g.name }}</span>
          {% endif %}
          {% endfor %}
          {% else %}
          &mdash;
          {% endif %}
          {% endwith %}
        </td>

        <td>
          {% if user.center %}
          {{ user.center.name }}
          {% else %}
          &mdash;
          {% endif %}
        </td>

        <td>
          {% if user.is_active %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-info"
                    hx-get="{% url 'accounts:user_detail' user.id %}"
                    hx-target="#modal-content"
                    @click="modalTitle = 'Chi tiết người dùng: {{ user.username|escapejs }}'"
                    data-bs-toggle="modal"
                    data-bs-target="#user-modal">
                <i class="bi bi-eye"></i>
            </button>
            
            <form hx-post="{% url 'accounts:delete_users' %}" hx-swap="none" class="d-inline"
                  data-confirm-title="Xác nhận xóa"
                  data-confirm-text="Bạn có chắc chắn muốn xóa người dùng '{{ user.username }}'?">
                {% csrf_token %}
                <input type="hidden" name="user_ids" value="{{ user.id }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </td>
      </tr>
      {% endfor %}
      {% endfor %}
      {% elif group_by == "center" %}
      {% regroup page_obj.object_list by center.name as center_list %}
      {% for cgroup in center_list %}
      <tr class="table-group">
        <td colspan="9"><strong>{{ cgroup.grouper|default:"(No center)" }}</strong></td>
      </tr>
      {% for user in cgroup.list %}
      <tr>
        <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
        <td>{{ user.get_full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.phone }}</td>
        <td>
          {% with g=user.groups.first %}
          {% if g %}
          {{ g.name }}
          {% else %}
          {{ user.get_role_display }}
          {% endif %}
          {% endwith %}
        </td>

        <td>
          {% with first_group=user.groups.first %}
          {% if first_group %}
          {% for g in user.groups.all %}
          {% if g.name == "Admin" %}
          <span class="badge bg-success">{{ g.name }}</span>
          {% elif g.name == "Teacher" %}
          <span class="badge bg-primary">{{ g.name }}</span>
          {% elif g.name == "Student" %}
          <span class="badge bg-warning text-dark">{{ g.name }}</span>
          {% elif g.name == "Parent" %}
          <span class="badge bg-orange" style="background-color: orange;">{{ g.name }}</span>
          {% else %}
          <span class="badge bg-secondary">{{ g.name }}</span>
          {% endif %}
          {% endfor %}
          {% else %}
          &mdash;
          {% endif %}
          {% endwith %}
        </td>


        <td>
          {% if user.center %}
          {{ user.center.name }}
          {% else %}
          &mdash;
          {% endif %}
        </td>

        <td>
          {% if user.is_active %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-info"
                    hx-get="{% url 'accounts:user_detail' user.id %}"
                    hx-target="#modal-content"
                    @click="modalTitle = 'Chi tiết người dùng: {{ user.username|escapejs }}'"
                    data-bs-toggle="modal"
                    data-bs-target="#user-modal">
                <i class="bi bi-eye"></i>
            </button>
            
            <form hx-post="{% url 'accounts:delete_users' %}" hx-swap="none" class="d-inline"
                  data-confirm-title="Xác nhận xóa"
                  data-confirm-text="Bạn có chắc chắn muốn xóa người dùng '{{ user.username }}'?">
                {% csrf_token %}
                <input type="hidden" name="user_ids" value="{{ user.id }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </td>
      </tr>
      {% endfor %}
      {% endfor %}
      {% else %}
      {% for user in page_obj.object_list %}
      <tr>
        <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
        <td>{{ user.get_full_name }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.phone }}</td>
        <td>
          {% with g=user.groups.first %}
          {% if g %}
          {{ g.name }}
          {% else %}
          {{ user.get_role_display }}
          {% endif %}
          {% endwith %}
        </td>

        <td>
          {% with first_group=user.groups.first %}
          {% if first_group %}
          {% for g in user.groups.all %}
          {% if g.name == "Admin" %}
          <span class="badge bg-success">{{ g.name }}</span>
          {% elif g.name == "Teacher" %}
          <span class="badge bg-primary">{{ g.name }}</span>
          {% elif g.name == "Student" %}
          <span class="badge bg-warning text-dark">{{ g.name }}</span>
          {% elif g.name == "Parent" %}
          <span class="badge bg-orange" style="background-color: orange;">{{ g.name }}</span>
          {% else %}
          <span class="badge bg-secondary">{{ g.name }}</span>
          {% endif %}
          {% endfor %}
          {% else %}
          &mdash;
          {% endif %}
          {% endwith %}
        </td>

        <td>
          {% if user.center %}
          {{ user.center.name }}
          {% else %}
          &mdash;
          {% endif %}
        </td>

        <td>
          {% if user.is_active %}
          <span class="badge bg-success">Active</span>
          {% else %}
          <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-info"
                    hx-get="{% url 'accounts:user_detail' user.id %}"
                    hx-target="#modal-content"
                    @click="modalTitle = 'Chi tiết người dùng: {{ user.username|escapejs }}'"
                    data-bs-toggle="modal"
                    data-bs-target="#user-modal">
                <i class="bi bi-eye"></i>
            </button>
            
            <form hx-post="{% url 'accounts:delete_users' %}" hx-swap="none" class="d-inline"
                  data-confirm-title="Xác nhận xóa"
                  data-confirm-text="Bạn có chắc chắn muốn xóa người dùng '{{ user.username }}'?">
                {% csrf_token %}
                <input type="hidden" name="user_ids" value="{{ user.id }}">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9">No users</td>
      </tr>
      {% endfor %}
      {% endif %}
    </tbody>
  </table>
</div>

<div class="dataTable-bottom d-flex justify-content-between align-items-center">
  <div class="dataTable-info">
    Hiện {{ page_obj.start_index }} đến {{ page_obj.end_index }} trong tổng số {{ paginator.count }} mục
  </div>

<nav class="dataTable-pagination">
  <ul class="pagination">
    {# Nút "Đầu tiên" #}
    {% if page_obj.number > 1 %}
    <li class="page-item">
      <a hx-get="{% url 'accounts:manage_accounts' %}?page=1&per_page={{ per_page }}&q={{ q|urlencode }}&status={{ status|urlencode }}&role={{ role|urlencode }}&group={{ group|urlencode }}&group_by={{ group_by|urlencode }}{% if center %}&center={{ center|urlencode }}{% endif %}"
         hx-target="#accounts-table" hx-swap="innerHTML" class="page-link">
        Đầu
      </a>
    </li>
    {% endif %}

    {# Hiển thị các trang lân cận: trang hiện tại ±2 #}
    {% for p in paginator.page_range %}
      {% if p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
        <li class="page-item {% if page_obj.number == p %}active{% endif %}">
          <a hx-get="{% url 'accounts:manage_accounts' %}?page={{ p }}&per_page={{ per_page }}&q={{ q|urlencode }}&status={{ status|urlencode }}&role={{ role|urlencode }}&group={{ group|urlencode }}&group_by={{ group_by|urlencode }}{% if center %}&center={{ center|urlencode }}{% endif %}"
             hx-target="#accounts-table" hx-swap="innerHTML" class="page-link">
            {{ p }}
          </a>
        </li>
      {% endif %}
    {% endfor %}

    {# Nút "Cuối cùng" #}
    {% if page_obj.number < paginator.num_pages %}
    <li class="page-item">
      <a hx-get="{% url 'accounts:manage_accounts' %}?page={{ paginator.num_pages }}&per_page={{ per_page }}&q={{ q|urlencode }}&status={{ status|urlencode }}&role={{ role|urlencode }}&group={{ group|urlencode }}&group_by={{ group_by|urlencode }}{% if center %}&center={{ center|urlencode }}{% endif %}"
         hx-target="#accounts-table" hx-swap="innerHTML" class="page-link">
        Cuối
      </a>
    </li>
    {% endif %}
  </ul>
</nav>

</div>