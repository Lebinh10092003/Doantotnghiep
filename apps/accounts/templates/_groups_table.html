{% load group_tags %}

<div class="dataTable-container table-responsive">
  <table class="table table-striped dataTable-table" id="groups-table-content">
    <thead>
      <tr>
        <th><input type="checkbox" onclick="toggleAllGroupCheckboxes(this)"></th>
        <th>Tên nhóm (Role)</th>
        <th>Số lượng người dùng</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      {% for group in page_obj.object_list %}
      {% with is_protected=group.name|is_protected_group %}
      <tr>
        <td>
          <input type="checkbox" name="group_ids[]" value="{{ group.id }}" 
                 {% if is_protected %}disabled{% endif %}>
        </td>
        <td>
          {{ group.name }}
          {% if is_protected %}
            <span class="badge bg-light-info text-info ms-2" title="Nhóm hệ thống, không thể xóa">
              <i class="bi bi-shield-check"></i> Hệ thống
            </span>
          {% endif %}
        </td>
        
        <td>
          {% if group.user_count > 0 %}
            <a href="{% url 'accounts:manage_accounts' %}?role={{ group.name|urlencode }}&group_by=role"
               title="Xem danh sách {{ group.user_count }} người dùng trong nhóm này">
              {{ group.user_count }}
            </a>
          {% else %}
            0
          {% endif %}
        </td>
        
        <td>
          {% if perms.auth.view_group %}
          <button type="button" class="btn btn-sm btn-info"
                  hx-get="{% url 'accounts:group_view' group.id %}"
                  hx-target="#group-modal-content"
                  @click="modalTitle = 'Chi tiết nhóm: {{ group.name|escapejs }}'">
            <i class="bi bi-eye"></i>
          </button>
          {% endif %}
          {% if perms.auth.change_group %}
          <button type="button" class="btn btn-sm btn-warning" 
                  hx-get="{% url 'accounts:group_edit' group.id %}"
                  hx-target="#group-modal-content" 
                  @click="modalTitle = 'Chỉnh sửa nhóm: {{ group.name|escapejs }}'">
            <i class="bi bi-pencil-square"></i>
          </button>
          {% endif %}
          
          {% if perms.auth.delete_group %}
          <form hx-post="{% url 'accounts:group_delete' %}" hx-swap="none" class="d-inline"
                data-confirm-title="Xác nhận xóa"
                data-confirm-text="Bạn chắc chắn muốn xóa nhóm '{{ group.name }}'? (Chỉ xóa được nếu nhóm trống và không phải nhóm hệ thống)">
            {% csrf_token %}
            <input type="hidden" name="group_id_single" value="{{ group.id }}">
            <button type="submit" class="btn btn-danger btn-sm"
                    {% if is_protected %}
                      disabled title="Không thể xóa nhóm hệ thống"
                    {% elif group.user_count > 0 %}
                      disabled title="Không thể xóa nhóm đang có người dùng"
                    {% endif %}>
              <i class="bi bi-trash"></i>
            </button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endwith %}
      {% empty %}
      <tr>
        <td colspan="4" class="text-center">Không tìm thấy nhóm nào.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="dataTable-bottom d-flex justify-content-between align-items-center">
  <div class="dataTable-info">
    Hiển thị {{ page_obj.start_index }} đến {{ page_obj.end_index }} trong tổng số {{ paginator.count }} mục
  </div>

  <nav class="dataTable-pagination">
    <ul class="pagination">
      {% if page_obj.number > 1 %}
      <li class="page-item">
        <a hx-get="{% url 'accounts:manage_groups' %}?page=1&per_page={{ per_page }}" 
           hx-target="#groups-table" hx-swap="innerHTML" class="page-link">
          Đầu
        </a>
      </li>
      {% endif %}

      {% for p in paginator.page_range %}
        {% if p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
        <li class="page-item {% if page_obj.number == p %}active{% endif %}">
          <a hx-get="{% url 'accounts:manage_groups' %}?page={{ p }}&per_page={{ per_page }}"
             hx-target="#groups-table" hx-swap="innerHTML" class="page-link">
            {{ p }}
          </a>
        </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.number < paginator.num_pages %}
      <li class="page-item">
        <a hx-get="{% url 'accounts:manage_groups' %}?page={{ paginator.num_pages }}&per_page={{ per_page }}"
           hx-target="#groups-table" hx-swap="innerHTML" class="page-link">
          Cuối
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>