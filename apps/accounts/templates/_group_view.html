{% load static %}
{% load group_tags %}
<div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
  <div class="mb-3">
    <h5 class="mb-1"><i class="bi bi-people me-2"></i>Nhóm: {{ group.name }}</h5>
  </div>

  <ul class="nav nav-tabs" id="groupViewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions-pane" type="button" role="tab" aria-controls="permissions-pane" aria-selected="true">
        <i class="bi bi-shield-lock me-1"></i> Danh sách quyền
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab" aria-controls="users-pane" aria-selected="false">
        <i class="bi bi-people-fill me-1"></i> Danh sách người dùng
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <div class="tab-pane fade show active" id="permissions-pane" role="tabpanel" aria-labelledby="permissions-tab">
      <div class="border rounded p-2" style="max-height: 40vh; overflow-y: auto;">
        {% if functional_grouped_permissions %}
          {% for group_name, perms in functional_grouped_permissions.items %}
            <h6 class="mt-2">{{ group_name }}</h6>
            <div class="table-responsive ps-1 mt-1">
              {% if perms %}
                <table class="table table-sm align-middle mb-2">
                  <thead class="table-light">
                    <tr>
                      <th class="w-50">Chức năng</th>
                      {% for action_key, action_label in permission_actions %}
                        <th class="text-center" style="width: 80px;">{{ action_label }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for entry in perms %}
                      <tr>
                        <td class="fw-semibold">{{ entry.model }}</td>
                        {% for action_key, action_label in permission_actions %}
                          {% with perm_field=entry.permissions|get_item:action_key %}
                            <td class="text-center">
                              {% if perm_field %}
                                <span class="badge bg-light-success text-success"><i class="bi bi-check2"></i></span>
                              {% else %}
                                <span class="text-muted">&mdash;</span>
                              {% endif %}
                            </td>
                          {% endwith %}
                        {% endfor %}
                      </tr>
                      {% if entry.others %}
                        <tr class="table-borderless">
                          <td class="text-muted small">Khác</td>
                          <td colspan="{{ permission_actions|length }}" class="py-1">
                            <div class="d-flex flex-wrap gap-1">
                              {% for extra_id, extra_label in entry.others %}
                                <span class="badge bg-light-secondary text-dark">{{ extra_label }}</span>
                              {% endfor %}
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <p class="text-muted small mb-0">Không có quyền trong nhóm này.</p>
              {% endif %}
            </div>
            {% if not forloop.last %}
              <hr class="my-1">
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="text-muted">Nhóm này chưa được gán quyền nào.</p>
        {% endif %}
      </div>
    </div>

    <div class="tab-pane fade" id="users-pane" role="tabpanel" aria-labelledby="users-tab">
      <div id="group-users-tab-content"
           hx-get="{% url 'accounts:group_users' group.id %}?per_page_group=5"
           hx-trigger="load"
           hx-target="this"
           hx-swap="innerHTML">
        <div class="text-center text-muted py-3">Đang tải danh sách người dùng...</div>
      </div>
    </div>
  </div>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">Đóng</button>
</div>

