{% load widget_tweaks %}
{% load group_tags %} 

<form hx-post="{% if group %}{% url 'accounts:group_edit' group.id %}{% else %}{% url 'accounts:group_create' %}{% endif %}"
    hx-target="this"
    hx-swap="outerHTML"
    hx-on="htmx:afterSwap: this.querySelector('.modal-body')?.scrollTo({top: 0, behavior: 'instant'});">
    {% csrf_token %}
    <div class="modal-body p-0" style="max-height: none; overflow: visible;">
        {# Hiển thị lỗi non-field errors nếu có #}
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        {# --- TRƯỜNG TÊN NHÓM (ĐÃ SỬA) --- #}
        {% comment %} 
            Không cần logic 'readonly' ở đây nữa.
            File forms.py đã tự động thêm 'readonly' vào widget 
            nếu đó là nhóm hệ thống đang chỉnh sửa.
        {% endcomment %}
        <div class="mb-3 px-3 pt-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            {% render_field form.name class="form-control" %}
            {% if form.name.field.widget.attrs.readonly %}
            <div class="form-text">
                <i class="bi bi-shield-check"></i> Không thể thay đổi tên của nhóm hệ thống.
            </div>
            {% endif %}
            <div class="text-danger small mt-1">{{ form.name.errors|striptags }}</div>
        </div>

        {# Trường Quyền hạn - Hiển thị theo nhóm chức năng #}
        <div class="mb-3 px-3 pb-3">
            <label class="form-label">{{ form.permissions.label }}</label>
            <p class="text-muted small">Chọn các quyền cho nhóm này.</p>
            <div class="border rounded p-2" style="max-height: 40vh; overflow-y: auto;">
                {% for group_name, perms in functional_grouped_permissions.items %}
                    <div class="d-flex align-items-center justify-content-between mt-2">
                        <h6 class="mb-0">{{ group_name }}</h6>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-light btn-sm" title="Chọn tất cả"
                                onclick="document.querySelectorAll('[data-perm-group={{ group_name|slugify }}] input[type=checkbox]').forEach(cb=>cb.checked=true);">Chọn tất cả</button>
                            <button type="button" class="btn btn-light btn-sm" title="Bỏ chọn"
                                onclick="document.querySelectorAll('[data-perm-group={{ group_name|slugify }}] input[type=checkbox]').forEach(cb=>cb.checked=false);">Bỏ chọn</button>
                        </div>
                    </div>
                    <div class="table-responsive mt-2 perm-group" data-perm-group="{{ group_name|slugify }}">
                        {% if perms %}
                            <table class="table table-sm align-middle mb-2">
                                <thead class="table-light">
                                    <tr>
                                        <th class="w-50">Chức năng</th>
                                        {% for action_key, action_label in permission_actions %}
                                            <th class="text-center" style="width: 80px;">{{ action_label }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in perms %}
                                        <tr>
                                            <td class="fw-semibold">{{ entry.model }}</td>
                                            {% for action_key, action_label in permission_actions %}
                                                {% with perm_field=entry.permissions|get_item:action_key %}
                                                    <td class="text-center">
                                                        {% if perm_field %}
                                                            <div class="form-check d-flex justify-content-center mb-0">
                                                                <input type="checkbox" name="permissions" value="{{ perm_field.id }}" class="form-check-input"
                                                                    id="perm_{{ perm_field.id }}"
                                                                    {% if perm_field.id in form.permissions.value %}checked{% endif %}>
                                                                <label class="visually-hidden" for="perm_{{ perm_field.id }}">{{ action_label }} {{ entry.model }}</label>
                                                            </div>
                                                        {% else %}
                                                            <span class="text-muted">&mdash;</span>
                                                        {% endif %}
                                                    </td>
                                                {% endwith %}
                                            {% endfor %}
                                        </tr>
                                        {% if entry.others %}
                                            <tr class="table-borderless">
                                                <td class="text-muted small">Khác</td>
                                                <td colspan="{{ permission_actions|length }}" class="py-1">
                                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                                        {% for extra_id, extra_label in entry.others %}
                                                            <div class="form-check form-check-inline mb-0">
                                                                <input type="checkbox" name="permissions" value="{{ extra_id }}" class="form-check-input"
                                                                    id="perm_{{ extra_id }}"
                                                                    {% if extra_id in form.permissions.value %}checked{% endif %}>
                                                                <label class="form-check-label small" for="perm_{{ extra_id }}">{{ extra_label }}</label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="text-muted small mb-2">Không có quyền nào trong nhóm này.</p>
                        {% endif %}
                    </div>
                    {% if not forloop.last %}
                        <hr class="my-1">
                    {% endif %}
                {% endfor %}
                {% for error in form.permissions.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
    
</form>

