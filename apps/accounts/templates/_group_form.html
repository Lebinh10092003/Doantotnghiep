{% load widget_tweaks %}
{% load group_tags %} 

<form hx-post="{% if group %}{% url 'accounts:group_edit' group.id %}{% else %}{% url 'accounts:group_create' %}{% endif %}"
      hx-target="this"
      hx-swap="outerHTML">
    {% csrf_token %}
    <div class="modal-body">
        {# Hiển thị lỗi non-field errors nếu có #}
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        {# --- TRƯỜNG TÊN NHÓM (ĐÃ SỬA) --- #}
        {% comment %} 
            Chúng ta không cần logic 'readonly' ở đây nữa.
            File forms.py đã tự động thêm 'readonly' vào widget 
            nếu đó là nhóm hệ thống đang được chỉnh sửa.
        {% endcomment %}
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            
            {# SỬA: Đã xóa 'readonly=is_protected' #}
            {% render_field form.name class="form-control" %}
            
            {# Hiển thị giải thích (nếu trường bị readonly từ form) #}
            {% if form.name.field.widget.attrs.readonly %}
            <div class="form-text">
                <i class="bi bi-shield-check"></i> Không thể thay đổi tên của nhóm hệ thống.
            </div>
            {% endif %}
            
            <div class="text-danger small mt-1">{{ form.name.errors|striptags }}</div>
        </div>
        {# --- KẾT THÚC SỬA --- #}


        {# Trường Quyền hạn - Hiển thị theo Accordion chức năng #}
        <div class="mb-3">
            <label class="form-label">{{ form.permissions.label }}</label>
            <p class="text-muted small">Chọn các quyền cho nhóm này.</p>
            <div class="border rounded p-2" style="max-height: 40vh; overflow-y: auto;">
                {% for group_name, perms in functional_grouped_permissions.items %}
                    <h6 class="mt-2">{{ group_name }}</h6>
                    <div class="mb-2 ps-2">
                        {% for perm_id, perm_label in perms %}
                            <div class="form-check form-check-inline">
                                <input type="checkbox" name="permissions" value="{{ perm_id }}" class="form-check-input" id="perm_{{ perm_id }}"
                                    {% if perm_id in form.permissions.value %}checked{% endif %}>
                                <label class="form-check-label" for="perm_{{ perm_id }}">{{ perm_label }}</label>
                            </div>
                        {% endfor %}
                        {% if not perms %}
                            <p class="text-muted small mb-0">Không có quyền nào trong nhóm này.</p>
                        {% endif %}
                    </div>
                    {% if not forloop.last %}
                        <hr class="my-1">
                    {% endif %}
                {% endfor %}
                {% for error in form.permissions.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
</form>