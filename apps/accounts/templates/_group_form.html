{% load widget_tweaks %}
{% load group_tags %}

{# {% load get_item_filter %} - Bạn không cần filter này nếu dùng view nhóm theo chức năng lớn #}

<form hx-post="{% if group %}{% url 'accounts:group_edit' group.id %}{% else %}{% url 'accounts:group_create' %}{% endif %}"
      hx-target="this"
      hx-swap="outerHTML">
    {% csrf_token %}
    <div class="modal-body">
        {# Hiển thị lỗi non-field errors nếu có #}
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
            <p class="mb-0">{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        {# Trường Tên Nhóm #}
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            {% render_field form.name class="form-control" %}
            <div class="text-danger small mt-1">{{ form.name.errors|striptags }}</div>
        </div>

        {# Trường Quyền hạn - Hiển thị theo Accordion chức năng #}
        <div class="mb-3">
            <label class="form-label">{{ form.permissions.label }}</label>
            <p class="text-muted small">Chọn các quyền cho nhóm này.</p>

            {# === SỬA LỖI CUỘN: Áp dụng style cuộn cho div bao ngoài accordion === #}
            <div style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                <div class="accordion" id="permissionsAccordion">
                    {# Lặp qua các nhóm chức năng từ context view #}
                    {% for func_name, perms_list in functional_grouped_permissions.items %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ func_name|slugify }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ func_name|slugify }}" aria-expanded="false" aria-controls="collapse-{{ func_name|slugify }}">
                                Chức năng: <strong>{{ func_name }}</strong>
                            </button>
                        </h2>
                        <div id="collapse-{{ func_name|slugify }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ func_name|slugify }}" data-bs-parent="#permissionsAccordion">
                            {# Bỏ style cuộn ở đây #}
                            <div class="accordion-body">
                                {# Lặp qua danh sách tuple (perm_id, clear_label) trong nhóm chức năng #}
                                {% for perm_id, clear_label in perms_list %}
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="permissions" {# Tên input phải giống nhau #}
                                               value="{{ perm_id }}"
                                               id="perm_{{ perm_id }}"
                                               {% if perm_id in form.permissions.value %}checked{% endif %}>
                                        <label class="form-check-label" for="perm_{{ perm_id }}">
                                            {{ clear_label }} {# Sử dụng label từ view #}
                                        </label>
                                    </div>
                                {% endfor %}
                                {% if not perms_list %}
                                    <p class="text-muted small mb-0">Không có quyền nào trong nhóm này.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div> {# Kết thúc accordion #}
            </div> {# === Kết thúc div chứa style cuộn === #}

            {# Hiển thị lỗi chung của trường permissions #}
            <div class="text-danger small mt-1">{{ form.permissions.errors|striptags }}</div>
        </div>

    </div> {# Kết thúc modal-body #}

    <div class="modal-footer">
        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
</form>