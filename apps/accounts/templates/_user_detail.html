{% load static %}
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
    <div class="row">
        <div class="col-md-4 text-center">
            {% if user.avatar %}
            <img src="{{ user.avatar.url }}" class="img-fluid rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;" alt="Avatar">
            {% else %}
            <img src="{% static 'static/images/faces/1.jpg' %}" class="img-fluid rounded-circle mb-3" style="width: 120px; height: 120px;" alt="Default Avatar">
            {% endif %}
            <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
            <p class="text-muted mb-0">@{{ user.username }}</p>
            <span class="badge bg-info mt-2">{{ user.groups.first.name|default:"Chưa có vai trò" }}</span>
        </div>
        <div class="col-md-8">
            <table class="table table-borderless">
                <tbody>
                    <tr><th style="width: 30%;">Username:</th><td>{{ user.username }}</td></tr>
                    <tr><th>Email:</th><td>{{ user.email }}</td></tr>
                    <tr><th>Số điện thoại:</th><td>{{ user.phone }}</td></tr>
                    {% if user.groups.all|length == 0 %}
                    <tr><th>Trung tâm:</th><td>{{ user.center.name|default:"Chưa có" }}</td></tr>
                    {% endif %}
                    <tr><th>Nhóm:</th>
                        <td>
                            {% for group in user.groups.all %}
                                {% with color_class=group.profile.color_class|default:"bg-secondary" %}
                                    <span class="badge {{ color_class }} me-1">{{ group.name }}</span>
                                {% endwith %}
                            {% empty %}<span class="text-muted">Không thuộc nhóm nào</span>{% endfor %}
                        </td>
                    </tr>
                    <tr><th>Trạng thái:</th>
                        <td>
                            {% if user.is_active %}<span class="badge bg-light-success">Hoạt động</span>{% else %}<span class="badge bg-light-danger">Không hoạt động</span>{% endif %}
                        </td>
                    </tr>
                    <tr><th>Ngày tham gia:</th><td>{{ user.date_joined|date:"d/m/Y H:i" }}</td></tr>
                    <tr><th>Đăng nhập cuối:</th><td>
                        {% if user.last_login %}{{ user.last_login|date:"d/m/Y H:i" }}{% else %}Chưa đăng nhập{% endif %}
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Thông tin cá nhân bổ sung -->
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-person-vcard me-2"></i>Thông tin cá nhân</h6>
        <div class="table-responsive">
            <table class="table table-sm table-borderless">
                <tbody>
                    <tr><th style="width: 30%;">Ngày sinh:</th><td>{{ user.dob|date:"d/m/Y"|default:"Chưa có" }}</td></tr>
                    <tr><th>Giới tính:</th><td>{{ user.get_gender_display|default:"Chưa có" }}</td></tr>
                    <tr><th>Số CCCD/CMND:</th><td>{{ user.national_id|default:"Chưa có" }}</td></tr>
                    <tr><th>Địa chỉ:</th><td>{{ user.address|default:"Chưa có" }}</td></tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- Hiển thị danh sách con nếu là phụ huynh -->
    {% if children %}
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-people-fill me-2"></i>Danh sách con</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Họ và tên</th>
                        <th>Username</th>
                        <th>Trung tâm</th>
                        <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody>
                    {% for relation in children %}
                    <tr>
                        <td>{{ relation.student.get_full_name|default:relation.student.username }}</td>
                        <td>{{ relation.student.username }}</td>
                        <td>{{ relation.student.center.name|default:"N/A" }}</td>
                        <td>{{ relation.note|default:"" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center text-muted">Chưa có thông tin.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Hiển thị danh sách phụ huynh nếu là học sinh -->
    {% if parents %}
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-person-check-fill me-2"></i>Danh sách phụ huynh</h6>
        <ul class="list-group list-group-flush">
            {% for relation in parents %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="bi bi-person"></i> {{ relation.parent.get_full_name|default:relation.parent.username }} ({{ relation.parent.phone }})</span>
                {% if relation.note %}<small class="text-muted">Ghi chú: {{ relation.note }}</small>{% endif %}
            </li>
            {% empty %}
            <li class="list-group-item text-center text-muted">Chưa có thông tin.</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Hiển thị lớp học đang tham gia nếu là học sinh -->
    {% if enrolled_classes != None %}
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-journal-bookmark me-2"></i>Lớp học đang tham gia</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Tên lớp</th>
                        <th>Môn học</th>
                        <th>Trung tâm</th>
                    </tr>
                </thead>
                <tbody>
                    {% for enrollment in enrolled_classes %}
                    <tr>
                        <td>{{ enrollment.klass.name }}</td>
                        <td>{{ enrollment.klass.subject.name }}</td>
                        <td>{{ enrollment.klass.center.name|default:"N/A" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Chưa tham gia lớp nào.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Hiển thị lớp học đang dạy nếu là giáo viên -->
    {% if teaching_classes != None %}
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-easel-fill me-2"></i>Lớp học đang giảng dạy</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Tên lớp</th>
                        <th>Môn học</th>
                        <th>Trung tâm</th>
                    </tr>
                </thead>
                <tbody>
                    {% for klass in teaching_classes %}
                    <tr>
                        <td>{{ klass.name }}</td>
                        <td>{{ klass.subject.name }}</td>
                        <td>{{ klass.center.name|default:"N/A" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Chưa được phân công lớp nào.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Hiển thị lớp đang trợ giảng nếu là trợ giảng/giáo viên -->
    {% if assisting_classes != None %}
    <div class="mt-4 border-top pt-3">
        <h6><i class="bi bi-people me-2"></i>Lớp đang trợ giảng</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Tên lớp</th>
                        <th>Môn học</th>
                        <th>Trung tâm</th>
                    </tr>
                </thead>
                <tbody>
                    {% for klass in assisting_classes %}
                    <tr>
                        <td>{{ klass.name }}</td>
                        <td>{{ klass.subject.name }}</td>
                        <td>{{ klass.center.name|default:"N/A" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Chưa là trợ giảng lớp nào.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
        <span>Đóng</span>
    </button>
    {% if perms.accounts.change_user %}
        <button type="button" class="btn btn-primary"
            hx-get="{% url 'accounts:edit_user' user.id %}"
            hx-target="#user-modal #modal-content"
            @click="modalTitle = 'Chỉnh sửa: {{ user.username|escapejs }}'">
            <i class="bi bi-pencil-square"></i> Chỉnh sửa
        </button>
    {% endif %}
    {% if perms.accounts.delete_user %}
        <form hx-post="{% url 'accounts:delete_users' %}"
            hx-swap="none"
            class="d-inline"
            data-confirm-title="Xác nhận xóa"
            data-confirm-text="Bạn có chắc chắn muốn xóa người dùng '{{ user.username }}'?">
            {% csrf_token %}
            <input type="hidden" name="user_ids" value="{{ user.id }}">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash"></i> Xóa
            </button>
        </form>
    {% endif %}
</div>
