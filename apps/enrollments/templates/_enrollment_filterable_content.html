{% load humanize %}
<div x-data="{showFilters:false, modalTitle:'Bộ lọc'}">
  {% include "_filter_ui_controls.html" with filter=filter active_filter_name=active_filter_name model_name=model_name current_query_params=current_query_params active_filter_badges=active_filter_badges target_id='filterable-content' %}

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="dataTable-dropdown d-flex align-items-center gap-2">
      <select name="per_page"
              class="dataTable-selector form-select form-select-sm w-auto"
              hx-get="{{ request.path }}"
              hx-target="#filterable-content"
              hx-swap="innerHTML"
              hx-push-url="true"
              hx-include="#filter-form"
              hx-trigger="change"
              hx-vals='{"page": "1"}'>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
      </select>
      <label class="mb-0">mục trên trang</label>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <label class="form-label mb-0 small text-muted">Sắp xếp</label>
      <select name="order"
              class="form-select form-select-sm w-auto"
              hx-get="{{ request.path }}"
              hx-target="#filterable-content"
              hx-swap="innerHTML"
              hx-push-url="true"
              hx-include="#filter-form"
              hx-trigger="change"
              hx-vals='{"page": "1"}'>
        <option value="student_asc" {% if filter_params.order == "student_asc" or not filter_params.order %}selected{% endif %}>Tên học viên (A-Z)</option>
        <option value="student_desc" {% if filter_params.order == "student_desc" %}selected{% endif %}>Tên học viên (Z-A)</option>
        <option value="-joined_at" {% if filter_params.order == "-joined_at" %}selected{% endif %}>Ghi danh mới nhất</option>
        <option value="joined_at" {% if filter_params.order == "joined_at" %}selected{% endif %}>Ghi danh cũ nhất</option>
        <option value="-start_date" {% if filter_params.order == "-start_date" %}selected{% endif %}>Bắt đầu mới nhất</option>
        <option value="start_date" {% if filter_params.order == "start_date" %}selected{% endif %}>Bắt đầu cũ nhất</option>
      </select>
    </div>
  </div>

  <div id="enrollment-table-container" class="dataTable-wrapper dataTable-loading no-footer sortable searchable fixed-columns">
    <div class="dataTable-container table-responsive">
      <table class="table table-striped dataTable-table align-middle">
        <thead>
          <tr>
            <th>Học viên</th>
            <th>Lớp</th>
            <th>Trung tâm</th>
            <th>Trạng thái</th>
            <th>Ngày ghi danh</th>
            <th>Thời gian học</th>
            <th>Số tiền còn lại</th>
            <th>Ghi chú</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          {% for enrollment in page_obj.object_list %}
          <tr>
            <td>
              <div class="fw-semibold">{{ enrollment.student.display_name_with_email }}</div>
              <div class="text-muted small">{{ enrollment.student.user_code }}</div>
              <div class="text-muted small">{{ enrollment.student.phone|default:"-" }}</div>
            </td>
            <td>
              <div class="fw-semibold">{{ enrollment.klass.code }}</div>
              <div class="text-muted small">{{ enrollment.klass.name }}</div>
            </td>
            <td>{{ enrollment.klass.center.name|default:"-" }}</td>
            <td>
              {% if enrollment.status == "ACTIVE" %}
                <span class="badge bg-success text-white">Đang học</span>
              {% elif enrollment.status == "PAUSED" %}
                <span class="badge bg-warning text-dark">Bảo lưu</span>
              {% elif enrollment.status == "CANCELLED" %}
                <span class="badge bg-danger text-white">Nghỉ học</span>
              {% elif enrollment.status == "NEW" %}
                <span class="badge bg-info text-white">Mới</span>
              {% elif enrollment.status == "COMPLETED" %}
                <span class="badge bg-secondary text-white">Hoàn tất</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ enrollment.get_status_display }}</span>
              {% endif %}
            </td>
            <td>{{ enrollment.joined_at|date:"d/m/Y"|default:"-" }}</td>
            <td class="text-nowrap">
              <div><span class="text-muted small">Bắt đầu:</span> {{ enrollment.start_date|date:"d/m/Y"|default:"-" }}</div>
              <div><span class="text-muted small">Kết thúc:</span> {{ enrollment.end_date|date:"d/m/Y"|default:"-" }}</div>
            </td>
            <td class="text-nowrap">
              <div class="fw-semibold">{{ enrollment.sessions_remaining }} buổi</div>
              <div class="text-muted small">{{ enrollment.remaining_amount|default_if_none:0|intcomma }} ₫</div>
            </td>
            <td>{{ enrollment.note|default:"-" }}</td>
            <td class="text-nowrap">
              {% if flags.can_manage %}
                <div class="d-flex gap-1">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'billing:entries' enrollment.pk %}"
                     title="Chi tiết học phí">
                    <i class="bi bi-receipt"></i>
                  </a>
                  <button type="button"
                          class="btn btn-sm btn-outline-primary"
                          title="Chuyển phí"
                          hx-get="{% url 'enrollments:transfer' enrollment.pk %}"
                          hx-target="#enrollment-modal-content"
                          data-bs-toggle="modal"
                          data-bs-target="#enrollment-modal"
                          @click="$dispatch('set-page-modal-title', 'Chuyển phí ghi danh')">
                    <i class="bi bi-arrow-left-right"></i>
                  </button>
                    <button type="button"
                      class="btn btn-sm btn-warning"
                      title="Chỉnh sửa"
                      hx-get="{% url 'enrollments:update' enrollment.pk %}"
                      hx-target="#enrollment-modal-content"
                      data-bs-toggle="modal"
                      data-bs-target="#enrollment-modal"
                      @click="$dispatch('set-page-modal-title', 'Cập nhật ghi danh')">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button type="button"
                          class="btn btn-sm btn-danger"
                          title="Hủy ghi danh"
                          hx-post="{% url 'enrollments:cancel' enrollment.pk %}"
                          hx-swap="none"
                          data-confirm-title="Xác nhận hủy"
                          data-confirm-text="Bạn chắc chắn muốn hủy ghi danh này?">
                    <i class="bi bi-x-octagon"></i>
                  </button>
                </div>
              {% else %}
                <span class="text-muted small">-</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center">Không tìm thấy ghi danh phù hợp.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="dataTable-bottom d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div class="dataTable-info mb-0">
        Hiển thị {{ page_obj.start_index }} đến {{ page_obj.end_index }} trong tổng số {{ paginator.count }} mục
      </div>

      {% if page_obj.has_other_pages %}
      <nav class="dataTable-pagination">
        <ul class="pagination mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page=1&{{ current_query_params }}"
               hx-get="?page=1&{{ current_query_params }}"
               hx-target="#{{ target_id|default:'filterable-content' }}"
               hx-swap="innerHTML"
               hx-push-url="true">Đầu</a>
          </li>
          {% endif %}

          {% for i in paginator.page_range %}
            {% if i >= page_obj.number|add:'-2' and i <= page_obj.number|add:'2' %}
              <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ i }}&{{ current_query_params }}"
                   hx-get="?page={{ i }}&{{ current_query_params }}"
                   hx-target="#{{ target_id|default:'filterable-content' }}"
                   hx-swap="innerHTML"
                   hx-push-url="true">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ paginator.num_pages }}&{{ current_query_params }}"
               hx-get="?page={{ paginator.num_pages }}&{{ current_query_params }}"
               hx-target="#{{ target_id|default:'filterable-content' }}"
               hx-swap="innerHTML"
               hx-push-url="true">Cuối</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>

  <div class="modal fade" id="filter-modal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel" x-text="modalTitle">Bộ lọc</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="filter-modal-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail && evt.detail.target && evt.detail.target.id === 'filter-modal-content') {
      const modalEl = document.getElementById('filter-modal');
      if (modalEl) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    }
  });
</script>
