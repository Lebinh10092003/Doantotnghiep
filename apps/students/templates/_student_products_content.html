{% load static %}
{% include "_filter_ui_controls.html" with filter=filter active_filter_name=active_filter_name model_name=model_name current_query_params=current_query_params active_filter_badges=active_filter_badges target_id='filterable-content' %}

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div class="d-flex align-items-center gap-2">
    <label class="form-label mb-0 small text-muted">Sắp xếp</label>
    <select name="order"
            class="form-select form-select-sm w-auto products-action"
            hx-get="{{ list_url|default:request.path }}"
            hx-target="#filterable-content"
            hx-swap="innerHTML"
            hx-push-url="true"
            hx-include="#filter-form"
            hx-trigger="change"
            hx-vals='{"page":"1"}'>
      <option value="desc" {% if filter_params.order != "asc" %}selected{% endif %}>Mới nhất</option>
      <option value="asc" {% if filter_params.order == "asc" %}selected{% endif %}>Cũ nhất</option>
    </select>
  </div>
  <div class="dataTable-dropdown d-flex align-items-center gap-2 ms-auto">
    <select name="per_page"
            class="dataTable-selector form-select form-select-sm w-auto"
            hx-get="{{ list_url|default:request.path }}"
            hx-target="#filterable-content"
            hx-swap="innerHTML"
            hx-push-url="true"
            hx-include="#filter-form"
            hx-trigger="change"
            hx-vals='{"page":"1"}'>
      <option value="6" {% if per_page == 6 %}selected{% endif %}>6</option>
      <option value="9" {% if per_page == 9 %}selected{% endif %}>9</option>
      <option value="12" {% if per_page == 12 %}selected{% endif %}>12</option>
    </select>
    <label class="mb-0 small text-muted">mục/trang</label>
  </div>
</div>

{% if products %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
    {% for product in products %}
      <div class="col">
        <article class="card products-card h-100 rounded-4 overflow-hidden bg-white border border-light-subtle shadow-sm">
          {% if product.image %}
            <div class="ratio ratio-16x9">
              <img src="{{ product.image.url }}" class="w-100 h-100" style="object-fit: cover;" alt="{{ product.title }}">
            </div>
          {% else %}
            <div class="ratio ratio-16x9 bg-light">
              <img src="{% static 'assets/images/logo/logoprodcut.png' %}"
                   class="w-100 h-100"
                   style="object-fit: cover;"
                   alt="Sản phẩm mặc định">
            </div>
          {% endif %}
          <div class="card-body d-flex flex-column p-3 gap-1">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge products-badge small rounded-pill py-1 px-2">
                {% with subject=product.session.klass.subject %}
                  {{ subject.name|default:"Không xác định" }}
                {% endwith %}
              </span>
              <span class="text-muted small">{{ product.session.date|date:"d/m/Y" }}</span>
            </div>
            <h5 class="card-title fw-semibold mb-1">{{ product.title }}</h5>
            <div class="text-muted small mb-2 d-flex gap-2">
              <i class="bi bi-calendar-week mt-1"></i>
              <div>
                <div class="fw-semibold text-dark">Buổi học</div>
                <div>Buổi {{ product.session.index }} &middot; {{ product.session.date|date:"d/m/Y" }}
                  {% if product.session.start_time %}- {{ product.session.start_time|time:"H:i" }}{% endif %}
                  {% if product.session.end_time %} đến {{ product.session.end_time|time:"H:i" }}{% endif %}
                </div>
              </div>
            </div>
            <div class="text-muted small mb-2 d-flex gap-2">
              <i class="bi bi-layers mt-1"></i>
              <div>
                <div class="fw-semibold text-dark">Học phần</div>
                <div>
                  {% if product.session.lesson and product.session.lesson.module %}
                    Học phần {{ product.session.lesson.module.order }}: {{ product.session.lesson.module.title }}
                  {% elif product.session.lesson %}
                    {{ product.session.lesson.title }}
                  {% else %}
                    Chưa cập nhật học phần
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="text-muted small mb-2 d-flex gap-2">
              <i class="bi bi-person-circle mt-1"></i>
              <div>
                <div class="fw-semibold text-dark">Học sinh</div>
                <div>{{ product.student.display_name_with_email }}</div>
              </div>
            </div>
            <p class="text-muted small mb-3">
              {{ product.description|default:"Chưa có mô tả."|truncatechars:90 }}
            </p>
            <div class="mt-auto pt-3 border-top">
              <div class="text-muted small mb-3 d-flex align-items-center gap-2">
                <i class="bi bi-clock-history"></i>
                <span>Cập nhật {{ product.created_at|date:"H:i d/m" }}</span>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'students:student_product_detail' pk=product.pk %}" class="btn btn-success btn-sm rounded-pill flex-grow-1 text-white">
                  <i class="bi bi-eye me-1"></i>
                  Xem chi tiết
                </a>
                {% if is_student %}
                  <button class="btn btn-outline-secondary btn-sm rounded-pill px-3"
                          hx-get="{% url 'students:product_update' pk=product.pk %}"
                          hx-target="#student-product-modal-content"
                          data-bs-toggle="modal"
                          data-bs-target="#student-product-modal">
                    <i class="bi bi-pencil"></i>
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </article>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-center text-muted py-4">
    <p class="mb-1">Chưa có sản phẩm nào.</p>
    <small>Tạo dự án mới để bắt đầu.</small>
  </div>
{% endif %}

<div class="dataTable-bottom d-flex flex-wrap justify-content-between align-items-center gap-2 mt-4">
  <div class="dataTable-info mb-0">
    {% if products %}
      Hiển {{ page_obj.start_index }} đến {{ page_obj.end_index }} trong tổng số {{ paginator.count }} mục
    {% else %}
      Hiển 0 đến 0 trong tổng số 0 mục
    {% endif %}
  </div>

  {% if page_obj.has_other_pages %}
  <nav class="dataTable-pagination">
    <ul class="pagination mb-0">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page=1&{{ current_query_params }}"
           hx-get="?page=1&{{ current_query_params }}"
           hx-target="#filterable-content"
           hx-swap="innerHTML"
           hx-push-url="true">Đầu</a>
      </li>
      {% endif %}

      {% for i in paginator.page_range %}
        {% if i >= page_obj.number|add:'-2' and i <= page_obj.number|add:'2' %}
          <li class="page-item {% if page_obj.number == i %}active{% endif %}">
            <a class="page-link"
               href="?page={{ i }}&{{ current_query_params }}"
               hx-get="?page={{ i }}&{{ current_query_params }}"
               hx-target="#filterable-content"
               hx-swap="innerHTML"
               hx-push-url="true">{{ i }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ paginator.num_pages }}&{{ current_query_params }}"
           hx-get="?page={{ paginator.num_pages }}&{{ current_query_params }}"
           hx-target="#filterable-content"
           hx-swap="innerHTML"
           hx-push-url="true">Cuối</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
