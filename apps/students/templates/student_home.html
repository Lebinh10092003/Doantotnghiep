{% extends "base.html" %}
{% load static %}
{% load group_tags %}
{% block title %}Trang học sinh{% endblock %}

{% block content %}
<div id="student-portal-root" x-data="{ modalTitle: 'Đang tải...' }">
  <div id="main">
    <header class="mb-3">
      <a href="#" class="burger-btn d-block d-xl-none">
        <i class="bi bi-justify fs-3"></i>
      </a>
    </header>

    <div class="page-heading">
      <section class="section">

        {% if is_parent_portal %}
        <div class="alert alert-success-subtle border border-success-subtle text-success-emphasis rounded-4 mb-4">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <i class="bi bi-people-fill"></i>
            <div>
              <strong>Chế độ phụ huynh</strong>
              {% if has_linked_students and portal_student_labels %}
                • Lịch đang hiển thị cho: <span class="fw-semibold">{{ portal_student_labels }}</span>
              {% else %}
                • Bạn chưa được liên kết với học sinh nào. Vui lòng liên hệ trung tâm để được cập nhật.
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        {# ====== LỊCH HỌC (calendar ngang + panel bên phải) ====== #}
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lịch học</h5>
            <div class="d-flex align-items-center gap-3">
              <span class="text-muted small">
                {{ start|date:"d" }} - {{ end|date:"d F Y" }}
              </span>
              <div class="btn-group btn-group-sm" role="group">
                <a class="btn btn-outline-secondary"
                   href="?day={{ prev_week_str }}"
                   title="Tuần trước">
                  <i class="bi bi-chevron-left"></i>
                </a>
                <a class="btn btn-outline-secondary"
                   href="?day=today"
                   title="Tuần hiện tại">
                  Hôm nay
                </a>
                <a class="btn btn-outline-secondary"
                   href="?day={{ next_week_str }}"
                   title="Tuần sau">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="card-body" id="my-schedule-panel">
            {% include "_student_schedule_table.html" %}
          </div>
        </div>

        {# ====== LỚP HỌC VỚI GIÁO VIÊN ====== #}
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-0">
            <h5 class="mb-0">Lớp học với giáo viên</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              {% for item in class_cards %}
                {% with k=item.klass ns=item.next_session %}
                  <div class="col-12 col-md-6 col-xl-4">
                    <div class="card h-100 border-0 shadow-sm">
                      {% if k.subject.avatar_url %}
                        <img src="{{ k.subject.avatar_url }}"
                             class="card-img-top"
                             alt="{{ k.subject.name }}"
                             style="max-height: 200px; object-fit: cover;">
                      {% else %}
                        <img src="{% static 'compiled/jpg/1.jpg' %}"
                             class="card-img-top"
                             alt="{{ k.subject.name }}"
                             style="max-height: 200px; object-fit: cover;">
                      {% endif %}

                      <div class="card-body d-flex flex-column">
                        {% if is_parent_portal and item.student_label %}
                        <div class="mb-2">
                          <span class="badge rounded-pill bg-success-subtle text-success">
                            {{ item.student_label }}
                          </span>
                        </div>
                        {% endif %}
                        <div class="d-flex align-items-center mb-2">
                          <span class="border-start border-3 border-success me-2" style="height: 18px;"></span>
                          <h6 class="mb-0">{{ k.subject.name }}</h6>
                        </div>
                        <h5 class="mb-2">{{ k.name }}</h5>

                        {% if ns %}
                          <div class="small text-muted mb-3">
                            <i class="bi bi-calendar-event me-1"></i>
                            Buổi học tiếp theo:
                            {{ ns.date|date:"d/m/Y" }}
                            {{ ns.start_time|time:"H:i"|default:"" }}
                          </div>
                        {% else %}
                          <div class="small text-success mb-3">
                            <i class="bi bi-check-circle me-1"></i>
                            Khóa học đã kết thúc
                          </div>
                        {% endif %}

                        <div class="mt-auto">
                          <a href="{% url 'students:portal_course_detail' k.id %}"
                             class="btn w-100"
                             style="background-color: #24B273; color: #fff; border-radius: 999px;">
                            Xem chi tiết
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endwith %}
              {% empty %}
                <div class="col-12">
                  <div class="text-center py-4">
                    <i class="bi bi-emoji-neutral display-6 text-muted mb-2"></i>
                    {% if is_parent_portal and not has_linked_students %}
                    <p class="text-muted mb-1">Chưa có học sinh nào được liên kết với tài khoản phụ huynh.</p>
                    <p class="text-muted small mb-0">
                      Vui lòng liên hệ trung tâm để được hỗ trợ thêm.
                    </p>
                    {% else %}
                    <p class="text-muted mb-1">Bạn chưa đăng ký khóa học nào.</p>
                    <p class="text-muted small mb-0">
                      Liên hệ trung tâm hoặc giáo viên để được tư vấn và xếp lớp.
                    </p>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        {# ====== KHÓA HỌC TỰ ÔN (placeholder, để bạn phát triển sau) ====== #}
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0">
            <h5 class="mb-0">Khóa học tự ôn</h5>
          </div>
          <div class="card-body">
            {% if self_study_courses %}
              <div class="row g-3">
                {% for c in self_study_courses %}
                  <div class="col-12 col-md-6 col-xl-4">
                      {% static 'compiled/jpg/1.jpg' as fallback %}
                      <img src="{{ c.thumbnail_url|default:fallback }}"
                          class="card-img-top"
                          style="max-height: 200px; object-fit: cover;"
                          alt="{{ c.title }}">
                      <div class="card-body d-flex flex-column">
                        <h6 class="mb-2">{{ c.title }}</h6>
                        <p class="small text-muted flex-grow-1">{{ c.short_description }}</p>
                        <a href="{{ c.url }}" class="btn btn-outline-success w-100 mt-auto"
                           style="border-radius: 999px;">
                          Bắt đầu học
                        </a>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0 small">
                Tính năng khóa học tự ôn đang được phát triển.
              </p>
            {% endif %}
          </div>
        </div>

      </section>
    </div>
  </div>

  {# Modal xem chi tiết buổi học / bài học #}
  <div class="modal fade" id="sessions-modal" tabindex="-1"
       aria-labelledby="sessions-modal-label"
       aria-hidden="true"
       data-bs-backdrop="static"
       data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sessions-modal-label" x-text="modalTitle">
            Chi tiết
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div id="sessions-modal-content">
          <div class="modal-body">
            <p>Đang tải...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
