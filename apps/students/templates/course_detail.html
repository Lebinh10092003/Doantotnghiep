{% extends "base.html" %}
{% load static %}
{% load embed_tags %}
{% load group_tags %}

{% block title %}Chi tiết khóa học{% endblock %}

{% block content %}
{% now "Y-m-d" as today_str %}
<div id="student-portal-root"
     x-data="{
       modalTitle: 'Đang tải...',
       selectedLessonTitle: null,
       selectedLessonId: {% if lesson %}{{ lesson.id }}{% else %}null{% endif %},
       selectedSessionId: {% if selected_session %}{{ selected_session.id }}{% else %}null{% endif %},
       todayLessonId: {% if upcoming and upcoming.lesson and upcoming.date|date:'Y-m-d' == today_str %}{{ upcoming.lesson.id }}{% else %}null{% endif %},
       coursePanelUrl: '{{ course_panel_url|escapejs }}',
       buildCoursePanelUrl(sessionId) {
          const url = new URL(this.coursePanelUrl, window.location.origin);
          if (sessionId) {
            url.searchParams.set('session_id', sessionId);
          } else {
            url.searchParams.delete('session_id');
          }
          return `${url.pathname}${url.search}`;
        },
        selectLesson(sessionId, lessonId, lessonTitle, evt = null) {
          this.selectedLessonId = lessonId ?? null;
          this.selectedLessonTitle = lessonTitle || null;
          if (sessionId) {
            this.selectedSessionId = sessionId;
            if (evt) {
              evt.preventDefault();
              evt.stopPropagation();
            }
            const url = this.buildCoursePanelUrl(sessionId);
            if (window.history && window.history.replaceState) {
              window.history.replaceState({}, '', url);
            }
            if (window.htmx) {
              window.htmx.ajax('GET', url, { target: '#course-detail-panel', swap: 'outerHTML' });
            } else {
              window.location.href = url;
            }
          } else {
            this.selectedSessionId = null;
            const url = this.buildCoursePanelUrl(null);
            if (window.history && window.history.replaceState) {
              window.history.replaceState({}, '', url);
            }
            if (!window.htmx) {
              window.location.href = url;
            }
          }
        }
     }">
  <div id="main">
    <header class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
      <a href="#" class="burger-btn d-block d-xl-none">
        <i class="bi bi-justify fs-3"></i>
      </a>
      <button
        hx-get="{% url 'students:portal_home' %}"
        hx-target="body"
        hx-push-url="true"
        hx-indicator="#main"
        class="btn btn-light btn-sm d-inline-flex align-items-center gap-2 shadow-sm">
        <i class="fas fa-arrow-left fa-fw"></i>
        <span class="d-none d-sm-inline">Quay lại trang học sinh</span>
      </button>
    </header>

    <div class="page-heading">
      <section class="section">

        {% if is_parent_view %}
        <div class="alert alert-info-subtle border border-info-subtle text-info-emphasis rounded-4 mb-4">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <i class="bi bi-people-fill"></i>
            <div>
              <strong>Chế độ phụ huynh</strong>
              <div class="small">
                Đang xem dữ liệu của <span class="fw-semibold">{{ student_display_name }}</span>.
                Một số thao tác (nộp bài, đăng sản phẩm) chỉ thực hiện được trên tài khoản học sinh.
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
          <div class="row g-0 align-items-stretch">
            <div class="col-lg-4">
              <div class="ratio ratio-4x3 h-100">
                {% if subject.avatar_url %}
                  <img src="{{ subject.avatar_url }}" class="w-100 h-100" style="object-fit: cover;" alt="{{ subject.name }}">
                {% else %}
                  <img src="{% static 'compiled/jpg/1.jpg' %}" class="w-100 h-100" style="object-fit: cover;" alt="{{ subject.name }}">
                {% endif %}
              </div>
            </div>
            <div class="col-lg-8 p-4">
              <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge bg-primary-subtle text-primary">{{ subject.name }}</span>
                <span class="badge bg-info-subtle text-info">{{ klass.center.name }}</span>
                <span class="badge rounded-pill
                    {% if klass.status == 'ONGOING' %}bg-success-subtle text-success
                    {% elif klass.status == 'COMPLETED' %}bg-secondary-subtle text-secondary
                    {% elif klass.status == 'PLANNED' %}bg-warning-subtle text-warning
                    {% else %}bg-light text-muted{% endif %}">
                  {{ klass.get_status_display }}
                </span>
              </div>
              <h2 class="mb-2">{{ klass.name }}</h2>
              <p class="text-muted mb-4">
                Giáo viên:
                {% if klass.main_teacher %}
                  <strong>{{ klass.main_teacher.get_full_name }}</strong>
                {% else %}
                  <strong>Chưa phân công</strong>
                {% endif %}
                &middot; Phòng học: {{ klass.room.name|default:"Chưa có" }}
              </p>

              <div class="row g-3">
                <div class="col-md-4">
                  <div class="border rounded-4 p-3 h-100">
                    <div class="small text-muted mb-1">Ngày bắt đầu</div>
                    <div class="fw-semibold">{{ klass.start_date|date:"d/m/Y"|default:"--" }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded-4 p-3 h-100">
                    <div class="small text-muted mb-1">Ngày kết thúc</div>
                    <div class="fw-semibold">{{ klass.end_date|date:"d/m/Y"|default:"--" }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded-4 p-3 h-100">
                    <div class="small text-muted mb-1">Tình trạng lớp</div>
                    <div class="fw-semibold">{{ klass.get_status_display }}</div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                {% include "_session_meta.html" with session=upcoming klass=klass dom_id="session-meta-hero" empty_message="Chưa có buổi học tiếp theo cho lớp này." %}
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <a class="btn btn-outline-secondary"
                   href="{% url 'students:student_products_list' %}">
                  <i class="bi bi-collection-play me-1"></i>
                  Kho dự án
                </a>
                {% if can_manage_products %}
                <button class="btn text-white"
                        style="background-color: #24B273; border-radius: 999px;"
                        hx-get="{% url 'students:product_create' 0 %}"
                        hx-target="#student-product-modal-content"
                        data-bs-toggle="modal"
                        data-bs-target="#student-product-modal">
                  <i class="bi bi-plus-circle me-1"></i>
                  Đăng sản phẩm trong khóa
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm mb-4 mb-xl-0">
              <div class="card-header bg-white border-0">
                <h5 class="mb-0">Chương trình học</h5>
              </div>
              <div class="card-body">
                {% if modules %}
                  <div class="accordion" id="modules-accordion">
                    {% for m in modules %}
                      <div class="accordion-item mb-2 border-0">
                        <h2 class="accordion-header" id="heading-{{ m.id }}">
                          <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                                  type="button"
                                  data-bs-toggle="collapse"
                                  data-bs-target="#collapse-{{ m.id }}"
                                  aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                  aria-controls="collapse-{{ m.id }}">
                            <span class="fw-semibold">{{ m.title }}</span>
                          </button>
                        </h2>
                        <div id="collapse-{{ m.id }}"
                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                             aria-labelledby="heading-{{ m.id }}"
                             data-bs-parent="#modules-accordion">
                          <div class="accordion-body p-0">
                            <ul class="list-group list-group-flush">
                              {% for l in m.lessons.all %}
                                {% with linked_session=lesson_sessions|get_item:l.id %}
                                  <li class="list-group-item d-flex align-items-center gap-2"
                                      :class="{
                                        'bg-primary-subtle border-start border-3 border-primary': selectedLessonId === {{ l.id }},
                                        'bg-success-subtle border-start border-3 border-success': todayLessonId === {{ l.id }} && selectedLessonId !== {{ l.id }}
                                      }">
                                    <div class="flex-grow-1 overflow-hidden me-2"
                                         style="min-width:0; cursor: pointer;"
                                         role="button"
                                         hx-get="{% url 'curriculum:lesson_detail' l.id %}?as=inline&class_id={{ klass.id }}"
                                         hx-target="#pane-knowledge"
                                         hx-indicator="#pane-knowledge"
                                         hx-swap="innerHTML"
                                        @click="selectLesson({% if linked_session %}{{ linked_session.id }}{% else %}null{% endif %}, {{ l.id }}, '{{ l.title|escapejs }}', $event)">
                                    <div class="fw-semibold text-truncate text-break">{{ l.title }}</div>
                                    {% if upcoming and upcoming.lesson and upcoming.date|date:"Y-m-d" == today_str and l.id == upcoming.lesson.id %}
                                      <span class="badge bg-success-subtle text-success">Hôm nay</span>
                                    {% endif %}
                                    {% if l.objectives %}
                                      <div class="small text-muted text-truncate">
                                        {{ l.objectives|truncatechars:80 }}
                                      </div>
                                    {% endif %}
                                  </div>
                                  <div class="d-flex flex-shrink-0 gap-2">
                                    <button
                                       class="btn btn-sm btn-outline-secondary"
                                       hx-get="{% url 'curriculum:lesson_detail' l.id %}?as=inline&class_id={{ klass.id }}"
                                       hx-target="#pane-knowledge"
                                       hx-indicator="#pane-knowledge"
                                       hx-swap="innerHTML"
                                       @click.stop="selectLesson({% if linked_session %}{{ linked_session.id }}{% else %}null{% endif %}, {{ l.id }}, '{{ l.title|escapejs }}', $event)">
                                       <i class="bi bi-eye"></i>
                                    </button>
                                  </div>
                                  </li>
                                {% endwith %}
                              {% empty %}
                                <li class="list-group-item text-muted small">
                                  Chưa có bài học trong module này.
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted mb-0">
                    Chưa có chương trình học được cấu hình cho môn này.
                  </p>
                {% endif %}
              </div>
            </div>

            <div class="card border-0 shadow-sm mt-4">
              <div class="card-header bg-white border-0">
                <h6 class="mb-0">Thông tin lớp</h6>
              </div>
              <div class="card-body small">
                <dl class="row mb-0">
                  <dt class="col-5 text-muted">Mã lớp</dt>
                  <dd class="col-7">{{ klass.code }}</dd>
                  <dt class="col-5 text-muted">Môn học</dt>
                  <dd class="col-7">{{ subject.name }}</dd>
                  <dt class="col-5 text-muted">Trung tâm</dt>
                  <dd class="col-7">{{ klass.center.name }}</dd>
                  <dt class="col-5 text-muted">Giáo viên</dt>
                  <dd class="col-7">{{ klass.main_teacher.get_full_name|default:"Chưa phân công" }}</dd>
                  <dt class="col-5 text-muted">Phòng học</dt>
                  <dd class="col-7">{{ klass.room.name|default:"Chưa có" }}</dd>
                </dl>
              </div>
            </div>
          </div>

          {% include "_course_detail_panel.html" %}
        </div>

      </section>
    </div>
  </div>

  <div class="modal fade" id="sessions-modal" tabindex="-1"
       aria-labelledby="sessions-modal-label"
       aria-hidden="true"
       data-bs-backdrop="static"
       data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sessions-modal-label" x-text="modalTitle">
            Chi tiết
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div id="sessions-modal-content">
          <div class="modal-body">
            <p>Đang tải...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="student-product-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Dự án học sinh</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="student-product-modal-content">
          <div class="p-4 text-center text-muted">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div class="small">Đang tải...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{% include "_student_product_modal_helpers.html" %}
{% endblock %}
