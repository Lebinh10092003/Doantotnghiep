{% load embed_tags %}

{% if swap_session_meta %}
  {% include "_session_meta.html" with session=selected_session klass=klass dom_id="session-meta-wrapper" swap_oob=True empty_message="Chưa có thông tin buổi học cho lớp này." %}
{% endif %}

<div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
  <div>
    <div class="fw-semibold">
      {% if selected_session %}
        Buổi {{ selected_session.index|default:"--" }}{% if selected_session.lesson %}: {{ selected_session.lesson.title }}{% endif %}
      {% else %}
        Chưa chọn buổi học
      {% endif %}
    </div>
    <div class="small text-muted">
      {% if selected_session %}
        {{ selected_session.date|date:"d/m/Y"|default:"Chưa có ngày" }}
        {% if selected_session.start_time %}
          • {{ selected_session.start_time|time:"H:i" }}
          {% if selected_session.end_time %}- {{ selected_session.end_time|time:"H:i" }}{% endif %}
        {% endif %}
      {% else %}
        Vui lòng chọn một buổi học trong danh sách chương trình để xem sản phẩm.
      {% endif %}
    </div>
  </div>
  {% if can_manage_products %}
  <div class="d-flex flex-wrap gap-2">
    <button class="btn btn-primary btn-sm"
            hx-get="{% url 'students:product_create' 0 %}"
            hx-target="#student-product-modal-content"
            data-bs-toggle="modal"
            data-bs-target="#student-product-modal">
      <i class="bi bi-plus-lg me-1"></i>
      Đăng sản phẩm trong khóa
    </button>
    {% if selected_session and latest_product %}
      <button class="btn btn-outline-primary btn-sm"
              hx-get="{% url 'students:product_update' latest_product.id %}"
              hx-target="#student-product-modal-content"
              data-bs-toggle="modal"
              data-bs-target="#student-product-modal">
        <i class="bi bi-pencil me-1"></i>
        Sửa sản phẩm buổi {{ selected_session.index }}
      </button>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if selected_session and session_products %}
  <h6 class="mb-3">Sản phẩm của {{ product_owner_label }} trong buổi học này</h6>
  <div class="row g-3">
    {% for p in session_products %}
      <div class="col-12 col-md-6">
        <div class="border rounded-3 p-3 h-100">
          <div class="fw-semibold mb-1">{{ p.title }}</div>
          {% if p.description %}
            <div class="small mb-2" style="white-space: pre-line;">
              {{ p.description|truncatechars:200 }}
            </div>
          {% endif %}

          {% if p.embed_code %}
            <div class="mb-2">
              <div class="ratio ratio-16x9 rounded-3 overflow-hidden">
                {{ p.embed_code|safe_embed }}
              </div>
            </div>
          {% elif p.video %}
            <div class="mb-2 ratio ratio-16x9 rounded-3 overflow-hidden">
              <video controls class="w-100 h-100">
                <source src="{{ p.video.url }}">
              </video>
            </div>
          {% elif p.image %}
            <div class="mb-2">
              <img src="{{ p.image.url }}" alt="{{ p.title }}"
                   class="img-fluid rounded-3">
            </div>
          {% endif %}

          <div class="small text-muted">
            Buổi {{ p.session.index }} – {{ p.session.date|date:"d/m/Y" }}
          </div>

          {% if can_manage_products %}
          <div class="mt-3 d-flex gap-2">
            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    hx-get="{% url 'students:product_update' p.id %}"
                    hx-target="#student-product-modal-content"
                    data-bs-toggle="modal"
                    data-bs-target="#student-product-modal">
              Sửa
            </button>
            <button
              class="btn btn-outline-danger btn-sm"
              hx-post="{% url 'students:product_delete' p.id %}"
              hx-swap="none"
              data-confirm-title="Xác nhận xóa"
              data-confirm-text="Bạn có chắc muốn xóa dự án này? Hành động không thể hoàn tác."
              data-confirm-button="Xóa">
              Xóa
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% elif selected_session %}
  <p class="text-muted small mb-4">
    {{ product_owner_label|capfirst }} chưa có sản phẩm nào cho buổi học này.
  </p>
{% endif %}

{% if other_products %}
  {% if selected_session %}
    <hr class="my-4">
  {% endif %}
  <h6 class="mb-3">Sản phẩm của {{ product_owner_label }} ở các buổi khác</h6>
  <div class="row g-3">
    {% for p in other_products %}
      <div class="col-12 col-md-6">
        <div class="border rounded-3 p-3 h-100">
          <div class="fw-semibold mb-1">{{ p.title }}</div>
          <div class="small text-muted mb-2">
            Buổi {{ p.session.index }} – {{ p.session.date|date:"d/m/Y" }}
          </div>
          {% if p.embed_code %}
            <div class="mb-2">
              <div class="ratio ratio-16x9 rounded-3 overflow-hidden">
                {{ p.embed_code|safe_embed }}
              </div>
            </div>
          {% elif p.video %}
            <div class="mb-2 ratio ratio-16x9 rounded-3 overflow-hidden">
              <video controls class="w-100 h-100">
                <source src="{{ p.video.url }}">
              </video>
            </div>
          {% elif p.image %}
            <div class="mb-2">
              <img src="{{ p.image.url }}" alt="{{ p.title }}"
                   class="img-fluid rounded-3">
            </div>
          {% endif %}
          {% if p.description %}
            <div class="small text-muted" style="white-space: pre-line;">
              {{ p.description|truncatechars:180 }}
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if not selected_session and not other_products %}
  <p class="text-muted small mb-0">
    Không tìm thấy buổi học để hiển thị sản phẩm. Vui lòng kiểm tra lại lịch học hiện có.
  </p>
{% elif selected_session and not session_products and not other_products %}
  <p class="text-muted small mb-0">
    {{ product_owner_label|capfirst }} chưa có sản phẩm nào trong khóa học này.
  </p>
{% endif %}
