{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_create %}Đăng dự án{% else %}Cập nhật dự án{% endif %}{% endblock %}

{% block content %}
<div id="main">
  <header class="mb-3">
    <a href="{% url 'students:portal_course_detail' session.klass.id %}"
       class="btn btn-light btn-sm d-inline-flex align-items-center gap-2 shadow-sm">
      <i class="bi bi-arrow-left"></i>
      <span>Quay lại khóa học</span>
    </a>
  </header>

  <section class="section">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0">
        <h5 class="mb-0">{% if is_create %}Đăng sản phẩm buổi {{ session.index }}{% else %}Cập nhật sản phẩm{% endif %}</h5>
        <div class="text-muted small">Lớp: {{ session.klass.name }} • Ngày: {{ session.date|date:"d/m/Y" }}</div>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
          {% csrf_token %}
          {% if form.non_field_errors %}
          <div class="alert alert-warning" role="alert">{{ form.non_field_errors|first }}</div>
          {% endif %}

          <div class="mb-3">
            <label class="form-label" for="id_title">Tiêu đề</label>
            {{ form.title }}
            {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors|first }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="id_description">Mô tả</label>
            {{ form.description }}
            {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors|first }}</div>{% endif %}
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="id_image">Ảnh minh họa</label>
              {{ form.image }}
              <div class="mt-2">
                <img id="image-preview"
                     src="{% if not is_create and form.instance.image %}{{ form.instance.image.url }}{% endif %}"
                     alt="Xem trước ảnh" class="img-fluid rounded-3">
              </div>
              {% if form.image.errors %}<div class="invalid-feedback d-block">{{ form.image.errors|first }}</div>{% endif %}
            </div>

            <div class="col-md-6">
              <label class="form-label" for="id_video">Video</label>
              {{ form.video }}
              {% if form.video.errors %}<div class="invalid-feedback d-block">{{ form.video.errors|first }}</div>{% endif %}
              <div class="mt-2">
                <div id="video-preview-wrapper" class="ratio ratio-16x9 rounded-3 overflow-hidden" style="display:none;">
                  <video id="video-preview" controls class="w-100 h-100"></video>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label" for="id_embed_code">Mã nhúng</label>
            {{ form.embed_code }}
            <div class="form-text">Bạn có thể dán iframe hoặc mã nhúng từ YouTube, Vimeo, itch.io...</div>
            {% if form.embed_code.errors %}<div class="invalid-feedback d-block">{{ form.embed_code.errors|first }}</div>{% endif %}
            <div class="mt-2 border rounded-3 p-2 bg-light-subtle">
              <div class="fw-semibold small mb-2">Xem trước mã nhúng</div>
              <div id="embed-preview" class="ratio ratio-16x9 rounded-3 overflow-hidden bg-dark-subtle d-flex align-items-center justify-content-center text-muted">
                {% if not is_create and form.instance.embed_code %}
                  <div class="w-100 h-100">{{ form.instance.embed_code|safe }}</div>
                {% else %}
                  <span class="small">Dán mã nhúng để xem trước</span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex justify-content-end gap-2">
            <a class="btn btn-light" href="{% url 'students:portal_course_detail' session.klass.id %}">Hủy</a>
            <button type="submit" class="btn btn-primary">Lưu</button>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>

<script>
  (function() {
    const input = document.getElementById('id_image');
    const preview = document.getElementById('image-preview');
    if (!input) return;
    input.addEventListener('change', function(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) { if (preview) preview.style.display = 'none'; return; }
      if (!file.type.startsWith('image/')) { if (preview) preview.style.display = 'none'; return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        if (!preview) return;
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });
  })();
  (function() {
    const videoInput = document.getElementById('id_video');
    const videoEl = document.getElementById('video-preview');
    const wrapper = document.getElementById('video-preview-wrapper');
    if (!videoInput) return;
    videoInput.addEventListener('change', function(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) { if (wrapper) wrapper.style.display = 'none'; return; }
      if (!file.type.startsWith('video/')) { if (wrapper) wrapper.style.display = 'none'; return; }
      const url = URL.createObjectURL(file);
      if (videoEl) {
        videoEl.src = url;
        if (wrapper) wrapper.style.display = 'block';
      }
    });
  })();
  (function() {
    const embedInput = document.getElementById('id_embed_code');
    const embedPreview = document.getElementById('embed-preview');
    if (!embedInput || !embedPreview) return;
    const render = () => {
      const val = embedInput.value ? embedInput.value.trim() : '';
      if (!val) { embedPreview.style.display = 'none'; embedPreview.innerHTML = '<span class="small text-muted">Dán mã nhúng để xem trước</span>'; return; }
      if (val.includes('<iframe')) {
        embedPreview.innerHTML = '<div class="w-100 h-100">' + val + '</div>';
        embedPreview.style.display = 'block';
      } else {
        embedPreview.innerHTML = '<div class="small text-muted p-2">Mã không phải iframe. Vui lòng dùng iframe (YouTube, Vimeo...).</div>';
        embedPreview.style.display = 'block';
      }
    };
    embedInput.addEventListener('input', render);
  })();
</script>
{% endblock %}

