{% load widget_tweaks %}

<form hx-post="{% if klass %}{% url 'classes:class_edit' klass.pk %}{% else %}{% url 'classes:class_add' %}{% endif %}"
      hx-encoding="multipart/form-data"
      hx-target="this" hx-swap="outerHTML">
    {% csrf_token %}
    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
            </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ form.code.id_for_label }}" class="form-label">Mã lớp</label>
                    {% render_field form.code class="form-control" %}
                    {% if form.code.errors %}<div class="invalid-feedback d-block">{{ form.code.errors|first }}</div>{% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ form.name.id_for_label }}" class="form-label">Tên lớp</label>
                    {% render_field form.name class="form-control" required="required" %}
                    {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors|first }}</div>{% endif %}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3"><label for="{{ form.center.id_for_label }}" class="form-label">{{ form.center.label }}</label>{% render_field form.center class="form-select" %}{% if form.center.errors %}<div class="invalid-feedback d-block">{{ form.center.errors|first }}</div>{% endif %}</div>
            <div class="col-md-6 mb-3"><label for="{{ form.subject.id_for_label }}" class="form-label">{{ form.subject.label }}</label>{% render_field form.subject class="form-select" %}{% if form.subject.errors %}<div class="invalid-feedback d-block">{{ form.subject.errors|first }}</div>{% endif %}</div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3"><label for="{{ form.start_date.id_for_label }}" class="form-label">{{ form.start_date.label }}</label>{% render_field form.start_date class="form-control" %}{% if form.start_date.errors %}<div class="invalid-feedback d-block">{{ form.start_date.errors|first }}</div>{% endif %}</div>
            <div class="col-md-6 mb-3"><label for="{{ form.end_date.id_for_label }}" class="form-label">{{ form.end_date.label }}</label>{% render_field form.end_date class="form-control" %}{% if form.end_date.errors %}<div class="invalid-feedback d-block">{{ form.end_date.errors|first }}</div>{% endif %}</div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3"><label for="{{ form.main_teacher.id_for_label }}" class="form-label">{{ form.main_teacher.label }}</label>{% render_field form.main_teacher class="form-select tom-select" %}{% if form.main_teacher.errors %}<div class="invalid-feedback d-block">{{ form.main_teacher.errors|first }}</div>{% endif %}</div>
            <div class="col-md-6 mb-3"><label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>{% render_field form.status class="form-select" %}{% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors|first }}</div>{% endif %}</div>
        </div>

        <div class="mb-3">
            <label for="{{ form.assistants.id_for_label }}" class="form-label">{{ form.assistants.label }}</label>
            {% render_field form.assistants class="form-select tom-select" %}
            {% if form.assistants.errors %}<div class="invalid-feedback d-block">{{ form.assistants.errors|first }}</div>{% endif %}
        </div>

        <hr>
        <h5>Lịch học hàng tuần</h5>
        {{ formset.management_form }}
        
        <div id="schedule-form-list">
            {% for schedule_form in formset %}
                <div class="row align-items-center schedule-form mb-2" id="schedule-{{ forloop.counter0 }}">
                    {{ schedule_form.id }}
                    <div class="col-4">
                        {% if forloop.first %}<label class="form-label small">Ngày trong tuần</label>{% endif %}
                        {% render_field schedule_form.day_of_week class="form-select form-select-sm" %}
                    </div>
                    <div class="col-3">
                        {% if forloop.first %}<label class="form-label small">Bắt đầu</label>{% endif %}
                        {% render_field schedule_form.start_time class="form-control form-control-sm" %}
                    </div>
                    <div class="col-3">
                        {% if forloop.first %}<label class="form-label small">Kết thúc</label>{% endif %}
                        {% render_field schedule_form.end_time class="form-control form-control-sm" %}
                    </div>
                    <div class="col-2 text-center">
                        {% if forloop.first %}<label class="form-label small d-block">&nbsp;</label>{% endif %}
                        {# Ẩn checkbox mặc định đi #}
                        <div class="d-none">{% render_field schedule_form.DELETE %}</div>
                        {# Luôn hiển thị nút bấm xóa #}
                        <button type="button" class="btn btn-danger btn-sm" data-action="remove-schedule-form" title="Xóa dòng này">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="text-danger small">{{ schedule_form.non_field_errors|striptags }}</div>
                </div>
            {% endfor %}
        </div>
        
        <div id="empty-form" class="d-none">
            <div class="row align-items-center schedule-form mb-2" id="schedule-__prefix__">
                {{ formset.empty_form.id }}
                {{ formset.empty_form.DELETE }}
                <div class="col-4">{% render_field formset.empty_form.day_of_week class="form-select form-select-sm" %}</div>
                <div class="col-3">{% render_field formset.empty_form.start_time class="form-control form-control-sm" %}</div>
                <div class="col-3">{% render_field formset.empty_form.end_time class="form-control form-control-sm" %}</div>
                <div class="col-2 text-center">
                    <button type="button" class="btn btn-danger btn-sm" data-action="remove-schedule-form" title="Xóa dòng này">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" data-action="add-schedule-form">
            <i class="bi bi-plus-lg"></i> Thêm lịch
        </button>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
</form>
