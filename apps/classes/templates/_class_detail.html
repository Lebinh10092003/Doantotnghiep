<div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
    <div class="row">
        <div class="col-md-6">
            <p><strong>Mã lớp:</strong> {{ klass.code }}</p>
            <p><strong>Trung tâm:</strong> {{ klass.center.name }}</p>
            <p><strong>Môn học:</strong> {{ klass.subject.name }}</p>
            <p><strong>Trạng thái:</strong> 
                {% if klass.status == 'PLANNED' %}
                    <span class="badge bg-info">{{ klass.get_status_display }}</span>
                {% elif klass.status == 'ONGOING' %}
                    <span class="badge bg-success">{{ klass.get_status_display }}</span>
                {% elif klass.status == 'COMPLETED' %}
                    <span class="badge bg-secondary">{{ klass.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-danger">{{ klass.get_status_display }}</span>
                {% endif %}
            </p>
        </div>
        <div class="col-md-6">
            <p><strong>Ngày bắt đầu:</strong> {{ klass.start_date|date:"d/m/Y"|default:"Chưa có" }}</p>
            <p><strong>Ngày kết thúc:</strong> {{ klass.end_date|date:"d/m/Y"|default:"Chưa có" }}</p>
            <p><strong>Giáo viên chính:</strong> {{ klass.main_teacher.display_name_with_email|default:"Chưa có" }}</p>
            <p><strong>Phòng học mặc định:</strong> {{ klass.room.name|default:"Chưa có" }}</p>
        </div>
    </div>

    <hr>

    <h5>Lịch học hàng tuần</h5>
    {% if klass.weekly_schedules.all %}
        <ul>
        {% for schedule in klass.weekly_schedules.all %}
            <li>
                <strong>{{ schedule.get_day_of_week_display }}:</strong> 
                {{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">Chưa có lịch học hàng tuần được thiết lập.</p>
    {% endif %}

    <hr>

    <h5>Học sinh</h5>
    {% with total=active_enrollments|length %}
      {% if total > 0 %}
        <div class="dataTable-container table-responsive">
          <table class="table table-striped dataTable-table align-middle mb-2">
            <thead>
              <tr>
                <th>Họ tên</th>
                <th>Tài khoản</th>
                <th>Ngày tham gia</th>
                <th>Trạng thái</th>
              </tr>
            </thead>
            <tbody>
              {% for e in active_enrollments %}
                {% if e.student %}
                <tr>
                  <td>{{ e.student.preferred_full_name }}</td>
                  <td class="text-muted">{{ e.student.display_name_with_email }}</td>
                  <td>{{ e.joined_at|date:"d/m/Y" }}</td>
                  <td><span class="badge bg-success">Đang học</span></td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="small text-muted">Tổng số: {{ total }}</div>
      {% else %}
        <p class="text-muted">Chưa có học sinh.</p>
      {% endif %}
    {% endwith %}

    <hr>

    <h5>Trợ giảng</h5>
    {% if klass.assistants.all %}
        <ul>
        {% for assistant in klass.assistants.all %}
            <li>{{ assistant.get_full_name }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">Không có trợ giảng.</p>
    {% endif %}

    <hr>

    <h5>Ghi chú</h5>
    <p>{{ klass.note|default:"Không có ghi chú." }}</p>

</div>

<div class="modal-footer justify-content-between">
    <div>
        {% if perms.class_sessions.change_classsession %}
        <button 
            type="button" 
            class="btn btn-info generate-sessions-btn"
            data-url="{% url 'classes:generate_sessions' pk=klass.pk %}"
            data-csrf="{{ csrf_token }}"
        >
            <i class="fas fa-cogs me-1"></i> Tạo lại lịch học
        </button>
        {% endif %}
    </div>
    <div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
    </div>
</div>

<script>
  (function() {
    const btn = document.currentScript.previousElementSibling.querySelector('.generate-sessions-btn');
    if (!btn) return;
    btn.addEventListener('click', function (e) {
      const url = this.getAttribute('data-url');
      const csrf = this.getAttribute('data-csrf');
      Swal.fire({
        icon: 'warning',
        title: 'Tạo lại lịch học?',
        text: "Cập nhật các buổi 'Đã lên kế hoạch' chưa diễn ra theo lịch tuần. Bạn có chắc chắn muốn tiếp tục?",
        showCancelButton: true,
        confirmButtonText: 'Tiếp tục',
        cancelButtonText: 'Hủy',
      }).then((result) => {
        if (result.isConfirmed) {
          htmx.ajax('POST', url, {
            target: 'body',
            swap: 'none',
            headers: {'X-CSRFToken': csrf}
          });
        }
      });
    }, { once: true });
  })();
</script>
