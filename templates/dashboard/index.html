{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Bảng điều khiển{% endblock %}

{% block content %}
<div id="main">
	<div class="page-heading">
		<div class="page-title">
			<div class="row align-items-center">
				<div class="col-12 col-lg-8">
					<div class="dashboard-hero">
						<p class="text-uppercase text-muted small mb-2">Xin chào</p>
						{% with display_name=request.user.get_full_name %}
						<h2 class="mb-2">{{ display_name|default:request.user.username }}</h2>
						{% endwith %}
						<p class="mb-3 text-muted">Bảng điều khiển được tối ưu theo vai trò để bạn nắm trạng thái hoạt động trong vài giây.</p>
						<div class="d-flex flex-wrap gap-2">
							<span class="badge bg-primary-subtle text-primary">
								{% if dashboard_role == 'admin' %}
									Quản trị hệ thống
								{% elif dashboard_role == 'center_manager' %}
									Quản lý trung tâm
								{% elif dashboard_role == 'parent' %}
									Phụ huynh
								{% elif dashboard_role == 'teacher_assistant' %}
									Giáo viên / Trợ giảng
								{% else %}
									Người dùng tiêu chuẩn
								{% endif %}
							</span>
							<span class="badge bg-light text-body">Cập nhật cuối: {% now "d/m/Y H:i" %}</span>
						</div>
					</div>
				</div>
				<div class="col-12 col-lg-4 text-lg-end mt-3 mt-lg-0">
					<a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary btn-sm me-lg-2">
						<i class="bi bi-person-circle"></i> Hồ sơ của tôi
					</a>
					<a href="{% url 'common:home' %}" class="btn btn-light btn-sm">
						<i class="bi bi-house"></i> Trang chủ
					</a>
				</div>
			</div>
		</div>
	</div>

	<section class="section pb-5" data-dashboard-role="{{ dashboard_role }}">
		{% if dashboard_role == 'admin' %}
			<div class="row g-4">
				<div class="col-12 col-md-4 col-xl">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<p class="stat-card__label mb-1">Trung tâm</p>
								<div class="stat-card__value">{% if centers_count is not None %}{{ centers_count|intcomma }}{% else %}&mdash;{% endif %}</div>
							</div>
							<span class="stat-card__icon"><i class="bi bi-building"></i></span>
						</div>
						<p class="text-muted small mb-0">Tổng số trung tâm đang hoạt động trong hệ thống.</p>
					</div>
				</div>
				<div class="col-12 col-md-4 col-xl">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<p class="stat-card__label mb-1">Phòng học</p>
								<div class="stat-card__value">{% if rooms_count is not None %}{{ rooms_count|intcomma }}{% else %}&mdash;{% endif %}</div>
							</div>
							<span class="stat-card__icon"><i class="bi bi-door-open"></i></span>
						</div>
						<p class="text-muted small mb-0">Số phòng học được khai báo.</p>
					</div>
				</div>
				<div class="col-12 col-md-4 col-xl">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<p class="stat-card__label mb-1">Người dùng</p>
								<div class="stat-card__value">{% if users_count is not None %}{{ users_count|intcomma }}{% else %}&mdash;{% endif %}</div>
							</div>
							<span class="stat-card__icon"><i class="bi bi-people"></i></span>
						</div>
						<p class="text-muted small mb-0">Tổng số tài khoản đã tạo.</p>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<p class="stat-card__label mb-1">Nhóm quyền</p>
								<div class="stat-card__value">{% if groups_count is not None %}{{ groups_count|intcomma }}{% else %}&mdash;{% endif %}</div>
							</div>
							<span class="stat-card__icon"><i class="bi bi-shield-lock"></i></span>
						</div>
						<p class="text-muted small mb-0">Kiểm tra phân quyền định kỳ.</p>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl">
					<div class="stat-card">
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<p class="stat-card__label mb-1">Lớp học</p>
								<div class="stat-card__value">{% if classes_count is not None %}{{ classes_count|intcomma }}{% else %}&mdash;{% endif %}</div>
							</div>
							<span class="stat-card__icon"><i class="bi bi-journal-bookmark"></i></span>
						</div>
						<p class="text-muted small mb-0">Tổng số lớp đã mở.</p>
					</div>
				</div>
			</div>

			<div class="row g-4 mt-1">
				<div class="col-12 col-xl-7">
					<div class="card h-100 chart-card">
						<div class="card-header d-flex justify-content-between align-items-center">
							<div>
								<h5 class="card-title mb-1">Hiệu suất từng trung tâm</h5>
								<p class="text-muted small mb-0">Lớp đang chạy và học viên đang hoạt động.</p>
							</div>
							{% if admin_chart_centers_has_data %}
							<span class="badge bg-success-subtle text-success">Realtime</span>
							{% else %}
							<span class="badge bg-light text-muted">Chưa có dữ liệu</span>
							{% endif %}
						</div>
						<div class="card-body p-0">
							{% if admin_chart_centers_has_data %}
							<div class="table-responsive">
								<table class="table align-middle dashboard-table mb-0">
									<thead>
										<tr>
											<th>Trung tâm</th>
											<th class="text-center">Lớp đang mở</th>
											<th class="text-center">Học viên hoạt động</th>
										</tr>
									</thead>
									<tbody>
										{% for row in admin_chart_centers %}
										<tr>
											<td>
												<strong>{{ row.center }}</strong>
												<div class="text-muted small">Mã #{{ forloop.counter|stringformat:"02d" }}</div>
											</td>
											<td class="text-center fw-semibold">{{ row.classes|intcomma }}</td>
											<td class="text-center fw-semibold">{{ row.students|intcomma }}</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% else %}
							<div class="empty-state">Chưa có trung tâm nào phát sinh dữ liệu thống kê.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-5">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Lối tắt quản trị</h5>
							<p class="text-muted small mb-0">Thực hiện nhanh các quy trình thường gặp.</p>
						</div>
						<div class="card-body">
							<div class="d-grid gap-2">
								<a href="{% url 'accounts:manage_accounts' %}" class="btn btn-outline-primary btn-sm">
									<i class="bi bi-person-lines-fill"></i> Quản lý người dùng
								</a>
								<a href="{% url 'centers:centers_manage' %}" class="btn btn-outline-secondary btn-sm">
									<i class="bi bi-building"></i> Trung tâm & phòng học
								</a>
								<a href="{% url 'classes:manage_classes' %}" class="btn btn-outline-info btn-sm">
									<i class="bi bi-journal-bookmark"></i> Lớp & lịch học
								</a>
								<a href="{% url 'reports:enrollment_summary' %}" class="btn btn-outline-dark btn-sm">
									<i class="bi bi-graph-up"></i> Báo cáo ghi danh
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="row g-4 mt-1">
				<div class="col-12 col-xl-6">
					<div class="card h-100 chart-card">
						<div class="card-header d-flex justify-content-between align-items-center">
							<div>
								<h5 class="card-title mb-1">Xu hướng ghi danh 6 tháng</h5>
								<p class="text-muted small mb-0">Nguồn: Enrollment.created_at</p>
							</div>
							{% if admin_chart_enrollment_trend_has_data %}
							<span class="badge bg-success-subtle text-success">Có dữ liệu</span>
							{% else %}
							<span class="badge bg-light text-muted">Giả lập 0</span>
							{% endif %}
						</div>
						<div class="card-body" data-progress-group>
							{% if admin_chart_enrollment_trend %}
								{% for point in admin_chart_enrollment_trend %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ point.label }}</span>
										<span class="fw-semibold">{{ point.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-primary" role="progressbar" data-value="{{ point.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có bản ghi ghi danh mới.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-6">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Cơ cấu trạng thái ghi danh</h5>
							<p class="text-muted small mb-0">Theo Enrollment.status</p>
						</div>
						<div class="card-body" data-progress-group>
							{% if admin_chart_enrollment_status %}
								{% for item in admin_chart_enrollment_status %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-success" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có dữ liệu trạng thái ghi danh.</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

		{% elif dashboard_role == 'center_manager' %}
			<div class="row g-4">
				<div class="col-12 col-xl-4">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-0">Thông tin trung tâm</h5>
						</div>
						<div class="card-body">
							{% if center %}
							<h4 class="fw-semibold mb-1">{{ center.name }}</h4>
							<p class="text-muted small mb-3">{{ center.description|default:"" }}</p>
							<ul class="list-unstyled small mb-0">
								<li class="mb-1"><i class="bi bi-geo-alt text-primary"></i> {{ center.address|default:"Đang cập nhật" }}</li>
								<li class="mb-1"><i class="bi bi-telephone text-primary"></i> {{ center.phone|default:"Chưa có" }}</li>
								<li><i class="bi bi-envelope text-primary"></i> {{ center.email|default:"Chưa có" }}</li>
							</ul>
							{% else %}
							<div class="empty-state">Bạn chưa được gán trung tâm cụ thể.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-8">
					<div class="row g-4">
						<div class="col-12 col-md-6">
							<div class="stat-card">
								<p class="stat-card__label mb-1">Nhân sự</p>
								<div class="stat-card__value">{% if cm_users_count is not None %}{{ cm_users_count|intcomma }}{% else %}&mdash;{% endif %}</div>
								<p class="text-muted small mb-0">Tài khoản thuộc trung tâm.</p>
							</div>
						</div>
						<div class="col-12 col-md-6">
							<div class="stat-card">
								<p class="stat-card__label mb-1">Phòng học</p>
								<div class="stat-card__value">{% if cm_rooms_count is not None %}{{ cm_rooms_count|intcomma }}{% else %}&mdash;{% endif %}</div>
								<p class="text-muted small mb-0">Sẵn sàng cho lịch dạy.</p>
							</div>
						</div>
						<div class="col-12 col-md-4">
							<div class="stat-card">
								<p class="stat-card__label mb-1">Lớp đang mở</p>
								<div class="stat-card__value">{% if cm_classes_count is not None %}{{ cm_classes_count|intcomma }}{% else %}&mdash;{% endif %}</div>
								<p class="text-muted small mb-0">Theo trạng thái hoạt động.</p>
							</div>
						</div>
						<div class="col-12 col-md-4">
							<div class="stat-card">
								<p class="stat-card__label mb-1">Giáo viên</p>
								<div class="stat-card__value">{% if cm_teachers_count is not None %}{{ cm_teachers_count|intcomma }}{% else %}&mdash;{% endif %}</div>
								<p class="text-muted small mb-0">Bao gồm trợ giảng.</p>
							</div>
						</div>
						<div class="col-12 col-md-4">
							<div class="stat-card">
								<p class="stat-card__label mb-1">Học viên</p>
								<div class="stat-card__value">{% if cm_students_count is not None %}{{ cm_students_count|intcomma }}{% else %}&mdash;{% endif %}</div>
								<p class="text-muted small mb-0">Tính theo tài khoản đang học.</p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="row g-4 mt-1">
				<div class="col-12 col-xl-4">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-0">Trạng thái lớp học</h5>
						</div>
						<div class="card-body" data-progress-group>
							{% if center_class_status_chart %}
								{% for item in center_class_status_chart %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-warning" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có dữ liệu lớp học.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-4">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-0">Tình trạng ghi danh</h5>
						</div>
						<div class="card-body" data-progress-group>
							{% if center_enrollment_status_chart %}
								{% for item in center_enrollment_status_chart %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-success" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có hồ sơ ghi danh.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-4">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-0">Điểm danh 30 ngày</h5>
						</div>
						<div class="card-body" data-progress-group>
							{% if center_attendance_status_chart %}
								{% for item in center_attendance_status_chart %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-info" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có dữ liệu điểm danh.</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

		{% elif dashboard_role == 'parent' %}
			<div class="row g-4">
				{% with metrics=parent_summary_metrics %}
				<div class="col-12 col-sm-6 col-xl-2">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Số con</p>
						<div class="stat-card__value">{{ metrics.total_children|default:0 }}</div>
						<p class="text-muted small mb-0">Theo quan hệ phụ huynh - học sinh.</p>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-xl-2">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Lớp đang học</p>
						<div class="stat-card__value">{{ metrics.active_classes|default:0 }}</div>
						<p class="text-muted small mb-0">Tổng số lớp còn hiệu lực.</p>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-xl-2">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Đi học</p>
						<div class="stat-card__value">{% if metrics.attendance_rate %}{{ metrics.attendance_rate }}%{% else %}&mdash;{% endif %}</div>
						<p class="text-muted small mb-0">Tỉ lệ điểm danh trung bình.</p>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Vắng mặt</p>
						<div class="stat-card__value">{{ metrics.total_absences|default:0 }}</div>
						<p class="text-muted small mb-0">30 ngày gần nhất.</p>
					</div>
				</div>
				<div class="col-12 col-sm-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Điểm trung bình</p>
						<div class="stat-card__value">{% if metrics.average_score %}{{ metrics.average_score }}{% else %}&mdash;{% endif %}</div>
						<p class="text-muted small mb-0">Trên các bài đánh giá đã chấm.</p>
					</div>
				</div>
				{% endwith %}
			</div>

			<div class="card mt-4 chart-card">
				<div class="card-header d-flex flex-wrap justify-content-between align-items-center">
					<div>
						<h5 class="card-title mb-1">Chọn học sinh cần theo dõi</h5>
						<p class="text-muted small mb-0">Bạn có thể chuyển nhanh giữa các con.</p>
					</div>
					{% if parent_children_all %}
					<form method="get" class="d-flex gap-2 align-items-center">
						<label for="child" class="small text-muted mb-0">Học sinh</label>
						<select name="child" id="child" class="form-select form-select-sm">
							{% for child in parent_children_all %}
							{% with student=child.student %}
							<option value="{{ student.id }}" {% if student.id == parent_selected_child_id %}selected{% endif %}>{{ child.student_label|default:student }}</option>
							{% endwith %}
							{% endfor %}
						</select>
						<button type="submit" class="btn btn-primary btn-sm">Xem</button>
					</form>
					{% endif %}
				</div>
				<div class="card-body">
					{% if parent_children_cards %}
					<div class="row g-3">
						{% for child in parent_children_cards %}
						<div class="col-12 col-md-6 col-xl-3">
							<div class="stat-card h-100">
								<h5 class="mb-1">{{ child.student_label }}</h5>
								<p class="text-muted small mb-2">{{ child.primary_subjects|join:", "|default:"Chưa có môn học" }}</p>
								<div class="d-flex justify-content-between small mb-1">
									<span>Đi học</span>
									<span class="fw-semibold">{% if child.attendance_rate %}{{ child.attendance_rate }}%{% else %}&mdash;{% endif %}</span>
								</div>
								<div class="d-flex justify-content-between small mb-1">
									<span>Điểm TB</span>
									<span class="fw-semibold">{% if child.avg_score %}{{ child.avg_score }}{% else %}&mdash;{% endif %}</span>
								</div>
								<div class="d-flex justify-content-between small">
									<span>Lớp</span>
									<span class="fw-semibold">{{ child.enrollments|length }}</span>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% else %}
					<div class="empty-state">Chưa có dữ liệu con được liên kết.</div>
					{% endif %}
				</div>
			</div>

			<div class="row g-4 mt-1">
				<div class="col-12 col-xl-7">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Chi tiết lớp của con</h5>
							<p class="text-muted small mb-0">Thông tin lớp và trạng thái điểm danh mới nhất.</p>
						</div>
						<div class="card-body">
							{% if parent_selected_child %}
							<h5 class="fw-semibold mb-3">{{ parent_selected_child.student_label }}</h5>
							{% if parent_selected_child.enrollments %}
							<div class="table-responsive">
								<table class="table align-middle dashboard-table">
									<thead>
										<tr>
											<th>Lớp học</th>
											<th>Trung tâm</th>
											<th>Môn học</th>
											<th>Trạng thái điểm danh</th>
										</tr>
									</thead>
									<tbody>
										{% for enrollment in parent_selected_child.enrollments %}
										<tr>
											<td>{{ enrollment.klass.name }}</td>
											  <td>{{ enrollment.klass.center.name|default:"Chưa cập nhật" }}</td>
											<td>{{ enrollment.klass.subject.name|default:"Chưa cập nhật" }}</td>
											<td>
												{% if parent_selected_child.latest_attendance %}
													{% if parent_selected_child.latest_attendance.session.klass.id == enrollment.klass.id %}
														<span class="badge bg-success-subtle text-success">{{ parent_selected_child.latest_attendance.get_status_display }}</span>
													{% else %}
														<span class="badge bg-light text-muted">Chưa điểm danh</span>
													{% endif %}
												{% else %}
												<span class="badge bg-light text-muted">Chưa có</span>
												{% endif %}
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% else %}
							<div class="empty-state">Chưa có lớp nào cho học sinh này.</div>
							{% endif %}
							{% else %}
							<div class="empty-state">Chọn học sinh để xem chi tiết.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-5">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Cập nhật mới nhất</h5>
						</div>
						<div class="card-body">
							{% if parent_recent_updates %}
							<div class="timeline">
								{% for update in parent_recent_updates %}
								<div class="timeline-item">
									<div class="d-flex justify-content-between">
										<strong>{{ update.student.get_full_name|default:update.student.username }}</strong>
										<span class="text-muted small">{{ update.date|date:"d/m" }}</span>
									</div>
									<p class="mb-1 small text-muted">{{ update.klass.name }}</p>
									{% if update.status == 'P' %}
									<span class="badge bg-success-subtle text-success me-1">Có mặt</span>
									{% elif update.status == 'A' %}
									<span class="badge bg-danger-subtle text-danger me-1">Vắng</span>
									{% else %}
									<span class="badge bg-warning-subtle text-warning me-1">Đi trễ</span>
									{% endif %}
									{% if update.note %}
									<p class="small text-muted mb-0 mt-1">Ghi chú: {{ update.note }}</p>
									{% endif %}
								</div>
								{% endfor %}
							</div>
							{% else %}
							<div class="empty-state">Chưa có cập nhật điểm danh trong 30 ngày.</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			<div class="card mt-4 chart-card">
				<div class="card-header">
					<h5 class="card-title mb-1">Khoảnh khắc gần đây</h5>
					<p class="text-muted small mb-0">Ảnh được giáo viên tải lên sau mỗi buổi học.</p>
				</div>
				<div class="card-body">
					{% if parent_photo_feed %}
					<div class="photo-grid">
						{% for item in parent_photo_feed %}
						{% if item.photo.image %}
						<figure>
							<img src="{{ item.photo.image.url }}" alt="Ảnh buổi học">
							<figcaption>
								<strong class="d-block">{{ item.student_label }}</strong>
								<span class="text-muted">{{ item.klass_name }}</span>
							</figcaption>
						</figure>
						{% endif %}
						{% endfor %}
					</div>
					{% else %}
					<div class="empty-state">Chưa có kho ảnh nào được chia sẻ.</div>
					{% endif %}
				</div>
			</div>

		{% elif dashboard_role == 'teacher_assistant' %}
			<div class="row g-4">
				<div class="col-12 col-md-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Lớp đang dạy</p>
						<div class="stat-card__value">{{ teaching_classes_count|default:0 }}</div>
						<p class="text-muted small mb-0">Bao gồm vai trò trợ giảng.</p>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Buổi sắp diễn ra</p>
						<div class="stat-card__value">{{ upcoming_sessions_count|default:0 }}</div>
						<p class="text-muted small mb-0">7 ngày tới.</p>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Tuần này</p>
						<div class="stat-card__value">{% if teacher_weekly_sessions_chart %}{{ teacher_weekly_sessions_chart|length }}{% else %}&mdash;{% endif %}</div>
						<p class="text-muted small mb-0">Ngày được ghi nhận lịch dạy.</p>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl-3">
					<div class="stat-card">
						<p class="stat-card__label mb-1">Trạng thái buổi học</p>
						<div class="stat-card__value">{% if teacher_session_status_chart %}{{ teacher_session_status_chart|length }}{% else %}&mdash;{% endif %}</div>
						<p class="text-muted small mb-0">Các trạng thái phát sinh 30 ngày.</p>
					</div>
				</div>
			</div>

			<div class="row g-4 mt-1">
				<div class="col-12 col-xl-6">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Buổi dạy 7 ngày tới</h5>
						</div>
						<div class="card-body p-0">
							{% if upcoming_sessions_list %}
							<div class="table-responsive">
								<table class="table align-middle mb-0 dashboard-table">
									<thead>
										<tr>
											<th>Lớp</th>
											<th>Ngày</th>
											<th>Giờ</th>
											<th>Trạng thái</th>
										</tr>
									</thead>
									<tbody>
										{% for session in upcoming_sessions_list %}
										<tr>
											<td>
												<strong>{{ session.klass.name }}</strong>
												<div class="text-muted small">{{ session.lesson.name|default:"Chưa cập nhật bài" }}</div>
											</td>
											<td>{{ session.date|date:"d/m" }}</td>
											<td>
												{% if session.start_time %}{{ session.start_time|time:"H:i" }}{% else %}?{% endif %}
												{% if session.end_time %} - {{ session.end_time|time:"H:i" }}{% endif %}
											</td>
											<td><span class="badge bg-primary-subtle text-primary">{{ session.get_status_display }}</span></td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% else %}
							<div class="empty-state">Bạn chưa có buổi dạy nào trong tuần này.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-3">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Lịch tuần</h5>
						</div>
						<div class="card-body" data-progress-group>
							{% if teacher_weekly_sessions_chart %}
								{% for item in teacher_weekly_sessions_chart %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-primary" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có lịch tuần.</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-12 col-xl-3">
					<div class="card h-100 chart-card">
						<div class="card-header">
							<h5 class="card-title mb-1">Trạng thái buổi học</h5>
						</div>
						<div class="card-body" data-progress-group>
							{% if teacher_session_status_chart %}
								{% for item in teacher_session_status_chart %}
								<div class="mb-3">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="small text-muted">{{ item.label }}</span>
										<span class="fw-semibold">{{ item.value|intcomma }}</span>
									</div>
									<div class="progress progress-sm">
										<div class="progress-bar bg-secondary" role="progressbar" data-value="{{ item.value }}" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
								</div>
								{% endfor %}
							{% else %}
							<div class="empty-state">Chưa có thống kê trạng thái.</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

		{% else %}
			<div class="card chart-card">
				<div class="card-body">
					<h4 class="card-title">Chào mừng bạn đến với STEAM Center</h4>
					<p class="text-muted mb-3">Hiện tại tài khoản của bạn chưa có dashboard riêng. Vui lòng liên hệ quản trị viên để được phân quyền phù hợp.</p>
					<div class="d-flex flex-wrap gap-2">
						<a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary btn-sm">
							<i class="bi bi-person"></i> Cập nhật hồ sơ
						</a>
						<a href="{% url 'students:portal_home' %}" class="btn btn-outline-secondary btn-sm">
							<i class="bi bi-journal"></i> Xem lớp học
						</a>
						<a href="mailto:support@example.com" class="btn btn-light btn-sm">
							<i class="bi bi-envelope"></i> Liên hệ hỗ trợ
						</a>
					</div>
				</div>
			</div>
		{% endif %}
	</section>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
	(function () {
		document.addEventListener('DOMContentLoaded', function () {
			document.querySelectorAll('[data-progress-group]').forEach(function (container) {
				var bars = container.querySelectorAll('.progress-bar[data-value]');
				if (!bars.length) {
					return;
				}
				var values = Array.prototype.map.call(bars, function (bar) {
					return Number(bar.getAttribute('data-value')) || 0;
				});
				var maxValue = values.length ? Math.max.apply(null, values) : 1;
				if (maxValue === 0) {
					maxValue = 1;
				}
				bars.forEach(function (bar, index) {
					var value = values[index] || 0;
					var percent = Math.max((value / maxValue) * 100, 3);
					bar.style.width = percent + '%';
					bar.setAttribute('aria-valuenow', percent.toFixed(0));
				});
			});
		});
	})();
</script>
{% endblock %}
